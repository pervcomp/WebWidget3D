/*!
Copyright (C) 2012 Anna-Liisa Mattila / Deparment of Pervasive Computing, Tampere University of Technology

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
WIDGET3D={ElementType:{MAIN_WINDOW:0,GROUP:1,BASIC:2,TEXT:3,UNDEFINED:666},createFunctions:function(){var e=[],t={},n,r,i,s,o=!1,u=function(){var e=0;return function(){return++e}};WIDGET3D.id=u(),WIDGET3D.getEvents=function(){return i},WIDGET3D.getCanvas=function(){return s},WIDGET3D.getApplication=function(){return n},WIDGET3D.addObject=function(e){t[e.id_]=e},WIDGET3D.removeObject=function(e){delete t[e]},WIDGET3D.getObjectById=function(e){return t[e]},WIDGET3D.getAllObjects=function(){return t},WIDGET3D.getFocused=function(){return e},WIDGET3D.addFocus=function(t){e.push(t)},WIDGET3D.removeFocus=function(t){for(var n=0;n<e.length;++n)if(e[n]===t)return e.splice(n,1),!0;return!1},WIDGET3D.unfocusFocused=function(){for(var t=0;t<e.length;++t)e[t].unfocus();e=[]},WIDGET3D.isInitialized=function(){return o},WIDGET3D.init=function(e){var e=e||{};return e.container==undefined?(console.log("Container must be specified!"),console.log("Container has to be constructor method of container of used 3D-engine (eg. in three.js THREE.Object3D"),console.log("Initializing WIDGET3D failed!"),!1):(WIDGET3D.Container=e.container,e.canvas==undefined?(console.log("Canvas must be specified!"),console.log("Initializing WIDGET3D failed!"),!1):(s=e.canvas,n=new WIDGET3D.Application,e.collisionCallback==undefined||e.collisionCallback.callback==undefined?(console.log("CollisionCallback has to be JSON object containing attributes callback (and args, optional)"),console.log("Initializing WIDGET3D failed!"),!1):(i=new WIDGET3D.DomEvents(e.collisionCallback),o=!0,n)))}}},WIDGET3D.createFunctions(),WIDGET3D.getRealWidth=function(){return parseInt(window.getComputedStyle(WIDGET3D.getCanvas(),null).getPropertyValue("width"))},WIDGET3D.getRealHeight=function(){return parseInt(window.getComputedStyle(WIDGET3D.getCanvas(),null).getPropertyValue("height"))},WIDGET3D.getCanvasWidth=function(){return WIDGET3D.getCanvas().width},WIDGET3D.getCanvasHeight=function(){return WIDGET3D.getCanvas().height},WIDGET3D.mouseScreenCoordinates=function(e){var t={x:0,y:0};if(!e)e=window.event,t.x=e.x,t.y=e.y;else{var n=e.target,r=0,i=0;while(n.offsetParent)r+=n.offsetLeft,i+=n.offsetTop,n=n.offsetParent;t.x=e.pageX-r,t.y=e.pageY-i}return t},WIDGET3D.mouseCoordinates=function(e){var t=WIDGET3D.mouseScreenCoordinates(e),n=WIDGET3D.getRealWidth(),r=WIDGET3D.getRealHeight(),i={minX:0,maxX:n,minY:0,maxY:r},s=WIDGET3D.scaleCoordinates(t,i);return s},WIDGET3D.scaleCoordinates=function(e,t){var n=+((e.x-t.minX)/t.maxX)*2-1,r=-((e.y-t.minY)/t.maxY)*2+1;return{x:n,y:r}},WIDGET3D.calculateLimits=function(e,t,n){var r=e.x+t/2,i=e.x-t/2,s=e.y+n/2,o=e.y-n/2;return{minX:i,maxX:r,minY:o,maxY:s}},WIDGET3D.DomEvents=function(e){var t=this;t.collisions_={callback:e.callback,args:e.args},t.enabled_={},t.mainEventHandler=function(e){var n=Object.getPrototypeOf(e);if(n.hasOwnProperty(String("initMouseEvent")))return t.mouseEvent(e),!1;if(n.hasOwnProperty(String("initKeyboardEvent")))return t.keyboardEvent(e);t.triggerEvent(e)},t.mouseEvent=function(e){var n=t.collisions_.callback(e,t.collisions_.args),r=e.type,i=WIDGET3D.getApplication(),s=!0;for(var o=0;o<n.length;++o){var u=n[o];if(u&&u.events_.hasOwnProperty(r.toString()))for(var a=0;a<u.events_[r.toString()].length;++a)u.events_[r.toString()][a].bubbles||(s=!1),u.events_[r.toString()][a].callback(e);if(!s)break}if(s&&i.events_.hasOwnProperty(r.toString()))for(var f=0;f<i.events_[r.toString()].length;++f)i.events_[r.toString()][f].bubbles||(s=!1),i.events_[r.toString()][f].callback(e);return s},t.keyboardEvent=function(e){var t=e.type,n=WIDGET3D.getApplication();for(var r=0;r<n.childEvents_[t.toString()].length;++r)if(n.childEvents_[t.toString()][r]!=n&&n.childEvents_[t.toString()][r].inFocus_){var i=n.childEvents_[t.toString()][r];for(var s=0;s<i.events_[t.toString()].length;++s)i.events_[t.toString()][s].callback(e)}if(!n.inFocus_&&n.events_.hasOwnProperty(t.toString()))for(var o=0;o<n.events_[t.toString()].length;++o)n.events_[t.toString()][o].callback(e)},t.triggerEvent=function(e,t){var n=e.type;if(!t){var r=WIDGET3D.getApplication();for(var i=0;i<r.childEvents_[n.toString()].length;++i){var s=r.childEvents_[n.toString()][i];for(var o=0;o<s.events_[n.toString()].length;++o)s.events_[n.toString()][o].callback(e)}}else{var u=WIDGET3D.getObjectById(t);for(var a=0;a<u.events_[n.toString()].length;++a)u.events_[n.toString()][a].callback(e)}}},WIDGET3D.DomEvents.prototype.enableEvent=function(e){if(!this.enabled_.hasOwnProperty(e.toString())||this.enabled_.hasOwnProperty(e.toString())&&this.enabled_[e.toString()]===!1)window.addEventListener(e,this.mainEventHandler,!1),this.enabled_[e.toString()]=!0},WIDGET3D.DomEvents.prototype.disableEvent=function(e){return this.enabled_.hasOwnProperty(e.toString())&&this.enabled_[e.toString()]===!0?(window.removeEventListener(e,this.mainEventHandler,!1),this.enabled_[e.toString()]=!1,!0):!1},WIDGET3D.GuiObject=function(){this.isVisible_=!0,this.inFocus_=!1,this.id_=WIDGET3D.id(),this.updateCallbacks_=[],this.events_={checkEvent:function(e){return this.hasOwnProperty(e.toString())&&this[e.toString()]!=0?!0:!1},addCallback:function(e,t,n,r){if(!this.hasOwnProperty(e.toString())||this.hasOwnProperty(e.toString())&&this[e.toString()]===!1)this[e.toString()]=[];this[e.toString()].push({callback:t,bubbles:n,index:r})},removeCallback:function(e,t){if(this.hasOwnProperty(e.toString())&&Object.prototype.toString.apply(this[e.toString()])==="[object Array]")for(var n=0;n<this[e.toString()].length;++n)if(this[e.toString()][n].callback===t){var r=this[e.toString()][n].index;return this[e.toString()].splice(n,1),this[e.toString()].length==0&&(this[e.toString()]=!1),r}return!1},removeAll:function(e){if(this.hasOwnProperty(e.toString())&&Object.prototype.toString.apply(this[e.toString()])==="[object Array]"){var t=this[e.toString()][0].index;return this[e.toString()]=!1,t}return!1},remove:function(){var e=[];for(listener in this)if(this.hasOwnProperty(listener)&&Object.prototype.toString.apply(this[listener])==="[object Array]"){var t={name:listener,index:this[listener][0].index};e.push(t),listener=!1}return e}},WIDGET3D.addObject(this)},WIDGET3D.GuiObject.prototype.focus=function(){this.inFocus_||(this.inFocus_=!0,WIDGET3D.addFocus(this))},WIDGET3D.GuiObject.prototype.unfocus=function(){this.inFocus_&&(this.inFocus_=!1,WIDGET3D.removeFocus(this))},WIDGET3D.GuiObject.prototype.addEventListener=function(e,t,n){WIDGET3D.getEvents().enabled_[e.toString()]||WIDGET3D.getEvents().enableEvent(e);if(!this.events_.checkEvent(e))var r=WIDGET3D.getApplication().childEvents_.addObject(e,this);else var r=this.events_[e.toString()][0].index;n==undefined&&(n=!0),this.events_.addCallback(e,t,n,r)},WIDGET3D.GuiObject.prototype.removeEventListener=function(e,t){var n=this.events_.removeCallback(e,t);if(n===!1)return!1;if(this.events_[e.toString()]===!1){var r=WIDGET3D.getApplication();r.childEvents_[e.toString()].splice(n,1),r.childEvents_[e.toString()].length==0&&r.childEvents_.removeEvent(e);for(var i=0;i<r.childEvents_[e.toString()].length;++i)r.childEvents_[e.toString()][i].setNewEventIndex(e,i);return!0}},WIDGET3D.GuiObject.prototype.removeEventListeners=function(e){var t=this.events_.removeAll(e);if(t===!1)return!1;var n=WIDGET3D.getApplication();n.childEvents_[e.toString()].splice(t,1),n.childEvents_[e.toString()].length==0&&n.childEvents_.removeEvent(e);for(var r=0;r<n.childEvents_[e.toString()].length;++r)n.childEvents_[e.toString()][r].setNewEventIndex(e,r);return!0},WIDGET3D.GuiObject.prototype.removeAllListeners=function(){var e=this.events_.remove(),t=WIDGET3D.getApplication();for(var n=0;n<e.length;++n){var r=e[n].name,i=e[n].index;t.childEvents_[r].splice(i,1),t.childEvents_[r].length==0&&t.childEvents_.removeEvent(r);for(var s=0;s<t.childEvents_[r].length;++s)t.childEvents_[r][s].setNewEventIndex(r,s)}},WIDGET3D.GuiObject.prototype.setNewEventIndex=function(e,t){for(var n=0;n<this.events_[e.toString()].length;++n)this.events_[e.toString()][n].index=t;WIDGET3D.getApplication().childEvents_[e.toString()][t]=this},WIDGET3D.GuiObject.prototype.addUpdateCallback=function(e,t){this.updateCallbacks_.push({callback:e,arguments:t})},WIDGET3D.GuiObject.prototype.update=function(){for(var e=0;e<this.updateCallbacks_.length;++e)this.updateCallbacks_[e].callback(this.updateCallbacks_[e].arguments)},WIDGET3D.GuiObject.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.Basic=function(){WIDGET3D.GuiObject.call(this),this.mesh_,this.parent_},WIDGET3D.Basic.prototype=WIDGET3D.GuiObject.prototype.inheritance(),WIDGET3D.Basic.prototype.type_=WIDGET3D.ElementType.BASIC,WIDGET3D.Basic.prototype.setParent=function(e){this.parent_!=undefined&&(this.isVisible_&&this.mesh_&&this.parent_.container_.remove(this.mesh_),this.parent_.removeFromObjects(this)),this.parent_=e,this.parent_.children_.push(this),this.isVisible_&&this.mesh_&&this.parent_.container_.add(this.mesh_),this.parent_.isVisible_||this.hide()},WIDGET3D.Basic.prototype.setMesh=function(e){var t=WIDGET3D.getApplication();this.mesh_&&this.parent_?(this.isVisible_&&this.parent_.container_.remove(this.mesh_),t.removeMesh(this.mesh_),this.mesh_=e,this.isVisible_&&this.parent_.container_.add(this.mesh_)):this.parent_?(this.mesh_=e,this.isVisible_&&this.parent_.container_.add(this.mesh_)):this.mesh_=e,t.meshes_.push(this.mesh_)},WIDGET3D.Basic.prototype.show=function(){this.isVisible_||(this.isVisible_=!0,this.mesh_.visible=!0,this.parent_.container_.add(this.mesh_))},WIDGET3D.Basic.prototype.hide=function(){this.isVisible_&&(this.isVisible_=!1,this.mesh_.visible=!1,this.inFocus_&&this.unfocus(),this.parent_.container_.remove(this.mesh_))},WIDGET3D.Basic.prototype.remove=function(){this.hide(),this.removeAllListeners(),WIDGET3D.getApplication().removeMesh(this.mesh_),this.parent_.removeFromObjects(this),WIDGET3D.removeObject(this.id_)},WIDGET3D.Basic.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.GroupBase=function(){this.children_=[],this.container_=new WIDGET3D.Container},WIDGET3D.GroupBase.prototype.addChild=function(e){return e.setParent(this),e},WIDGET3D.GroupBase.prototype.hideNotFocused=function(){for(var e=0;e<this.children_.length;++e)this.children_[e].inFocus_||this.children_[e].hide()},WIDGET3D.GroupBase.prototype.removeFromObjects=function(e){for(var t=0;t<this.children_.length;++t)if(this.children_[t]===e){var n=this.children_.splice(t,1);return n[0]}return!1},WIDGET3D.Application=function(){WIDGET3D.GuiObject.call(this),WIDGET3D.GroupBase.call(this),this.meshes_=[],this.childEvents_={addObject:function(e,t){if(!this.hasOwnProperty(e.toString())||this.hasOwnProperty(e.toString())&&this[e.toString()]==0)this[e.toString()]=[];this[e.toString()].push(t);var n=this[e.toString()].length-1;return n},removeEvent:function(e){return this.hasOwnProperty(e.toString())&&this[e.toString()].length==0?(this[e.toString()]=!1,WIDGET3D.getEvents().disableEvent(e),!0):!1}}},WIDGET3D.Application.prototype=WIDGET3D.GuiObject.prototype.inheritance(),WIDGET3D.Application.prototype.addChild=WIDGET3D.GroupBase.prototype.addChild,WIDGET3D.Application.prototype.hideNotFocused=WIDGET3D.GroupBase.prototype.hideNotFocused,WIDGET3D.Application.prototype.removeFromObjects=WIDGET3D.GroupBase.prototype.removeFromObjects,WIDGET3D.Application.prototype.type_=WIDGET3D.ElementType.MAIN_WINDOW,WIDGET3D.Application.prototype.removeMesh=function(e){for(var t=0;t<this.meshes_.length;++t)if(this.meshes_[t]===e){var n=this.meshes_.splice(t,1);return n[0]}return!1},WIDGET3D.Group=function(){WIDGET3D.Basic.call(this),WIDGET3D.GroupBase.call(this),this.isVisible_},WIDGET3D.Group.prototype=WIDGET3D.Basic.prototype.inheritance(),WIDGET3D.Group.prototype.addChild=WIDGET3D.GroupBase.prototype.addChild,WIDGET3D.Group.prototype.hideNotFocused=WIDGET3D.GroupBase.prototype.hideNotFocused,WIDGET3D.Group.prototype.removeFromObjects=WIDGET3D.GroupBase.prototype.removeFromObjects,WIDGET3D.Group.prototype.type_=WIDGET3D.ElementType.GROUP,WIDGET3D.Group.prototype.setParent=function(e){this.parent_!=undefined?(this.parent_.container_.remove(this.container_),this.parent_.removeFromObjects(this),this.parent_=e,this.parent_.children_.push(this),this.parent_.container_.add(this.container_)):(this.parent_=e,this.parent_.children_.push(this),this.parent_.container_.add(this.container_))},WIDGET3D.Group.prototype.setMesh=function(e){var t=WIDGET3D.getApplication();this.mesh_?(this.isVisible_&&this.container_.remove(this.mesh_),t.removeMesh(this.mesh_),this.mesh_=e,this.isVisible_&&this.container_.add(this.mesh_),t.meshes_.push(this.mesh_)):(this.mesh_=e,t.meshes_.push(this.mesh_),this.container_.add(this.mesh_))},WIDGET3D.Group.prototype.show=function(){if(!this.isVisible_){for(var e=0;e<this.children_.length;++e)this.children_[e].show();this.isVisible_=!0,this.parent_.container_.add(this.container_),this.mesh_&&(this.mesh_.visible=!0,this.container_.add(this.mesh_))}},WIDGET3D.Group.prototype.hide=function(){if(this.isVisible_){for(var e=0;e<this.children_.length;++e)this.children_[e].hide();this.isVisible_=!1,this.inFocus_&&this.unfocus(),this.parent_.container_.remove(this.container_),this.mesh_&&(this.mesh_.visible=!1,this.container_.remove(this.mesh_))}},WIDGET3D.Group.prototype.remove=function(){while(this.children_.length>0)this.children_[0].remove();this.hide(),this.removeAllListeners(),this.mesh_&&WIDGET3D.getApplication().removeMesh(this.mesh_),this.parent_.container_.remove(this.container_),this.parent_.removeFromObjects(this),WIDGET3D.removeObject(this.id_)},WIDGET3D.Group.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.Text=function(e){WIDGET3D.Basic.call(this);var e=e||{};this.mutable_=e.mutable!==undefined?e.mutable:!0,this.cursor_=e.cursor!==undefined?e.cursor:"|",this.maxLength_=e.maxLength!==undefined?e.maxLength:!1,this.maxLineLength_=e.maxLineLength!==undefined?e.maxLineLength:this.maxLength_,this.endl_="\n",this.currentRow_="",this.text_="",this.rows_=[],this.textHandle_=this.text_,e.text&&this.setText(e.text)},WIDGET3D.Text.prototype=WIDGET3D.Basic.prototype.inheritance(),WIDGET3D.Text.prototype.type_=WIDGET3D.ElementType.TEXT,WIDGET3D.Text.prototype.setText=function(e){if(this.mutable_){for(var t=0;t<e.length;++t)this.addLetter(e[t]);this.update()}},WIDGET3D.Text.prototype.addLetter=function(e){if(this.mutable_){if(!this.maxLength_||this.text_.length<this.maxLength_)if(!this.maxLineLength_||this.currentRow_.length<this.maxLineLength_){this.currentRow_+=e,this.text_+=e;if(this.currentRow_.length==this.maxLineLength_||this.text_.length==this.maxLength_)this.rows_.push(this.currentRow_+this.endl_),this.currentRow_=""}else if(this.currentRow_.length==this.maxLineLength_||this.text_.length==this.maxLength_)this.rows_.push(this.currentRow_+this.endl_),this.currentRow_=e,this.text_+=e;this.textHandle_=this.text_,this.inFocus_&&(this.textHandle_+=this.cursor_),this.update()}},WIDGET3D.Text.prototype.erase=function(e){if(this.mutable_){for(i=0;i<e;++i)this.currentRow_.length!=0?(this.currentRow_=this.currentRow_.substring(0,this.currentRow_.length-1),this.currentRow_.length==0&&this.rows_.length!=0&&(this.currentRow_=this.rows_[this.rows_.length-1],this.rows_.splice(-1,1),this.currentRow_=this.currentRow_.substring(0,this.currentRow_.length-1))):this.rows_.length!=0&&(this.currentRow_=this.rows_[this.rows_.length-1],this.rows_.splice(-1,1),this.currentRow_=this.currentRow_.substring(0,this.currentRow_.length-2));this.text_=this.text_.substring(0,this.text_.length-e),this.textHandle_=this.text_,this.inFocus_&&(this.textHandle_+=this.cursor_),this.update()}},WIDGET3D.Text.prototype.focus=function(){this.mutable_&&!this.inFocus_&&(this.textHandle_=this.text_+this.cursor_),WIDGET3D.Basic.prototype.focus.call(this),this.update()},WIDGET3D.Text.prototype.unfocus=function(){this.inFocus_&&this.mutable_&&(this.textHandle_=this.text_),WIDGET3D.Basic.prototype.unfocus.call(this),this.update()},WIDGET3D.Text.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.CameraGroup=function(e){WIDGET3D.Group.call(this);var e=e||{};this.camera_=e.camera,this.container_.add(this.camera_)},WIDGET3D.CameraGroup.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.RollControls=function(e){var t=this;this.component_=e.component,this.mouseButton_=e.mouseButton!==undefined?e.mouseButton:0,this.shiftKey_=e.shiftKey!==undefined?e.shiftKey:!1,this.clickLocation_,this.rotationOnMouseDownY_,this.rotationOnMousedownX_;var n=this.component_.getRotation();this.modelRotationY_=n.y,this.modelRotationX_=n.x,this.rotate_=!1,this.mouseupHandler=function(e){if(t.rotate_){e.stopPropagation(),e.preventDefault(),t.rotate_=!1;var n=WIDGET3D.getApplication();n.removeEventListener("mousemove",t.mousemoveHandler),n.removeEventListener("mouseup",t.mouseupHandler)}},this.mousedownHandler=function(e){if(e.button===t.mouseButton_&&e.shiftKey===t.shiftKey_){e.stopPropagation(),e.preventDefault(),t.component_.focus();if(!t.rotate_){t.rotate_=!0,t.clickLocation_=WIDGET3D.mouseCoordinates(e),t.rotationOnMouseDownY_=t.modelRotationY_,t.rotationOnMouseDownX_=t.modelRotationX_;var n=WIDGET3D.getApplication();n.addEventListener("mousemove",t.mousemoveHandler,!1),n.addEventListener("mouseup",t.mouseupHandler,!1)}}},this.mousemoveHandler=function(e){if(t.rotate_){e.stopPropagation(),e.preventDefault();var n=WIDGET3D.mouseCoordinates(e);t.modelRotationY_=t.rotationOnMouseDownY_+(n.x-t.clickLocation_.x),t.modelRotationX_=t.rotationOnMouseDownX_+(n.y-t.clickLocation_.y)}},this.component_.addEventListener("mousedown",this.mousedownHandler,!1),this.animate=function(){var e=t.component_.getRotation(),n=e.y+(t.modelRotationY_-e.y)*.04,r=e.x+(t.modelRotationX_-e.x)*.04;t.component_.setRotationY(n),t.component_.setRotationX(r)},this.component_.addUpdateCallback(this.animate)};var THREEJS_WIDGET3D={createFunctions:function(){var e=!1,t,n,r,i,s;WIDGET3D.render=function(){var e=WIDGET3D.getAllObjects();for(var r in e)e.hasOwnProperty(r)&&e[r].update();t.render(i,n)},WIDGET3D.setViewport=function(e,r,i){t.setSize(e,r),n.aspect=i,n.updateProjectionMatrix()},WIDGET3D.getRenderer=function(){return t},WIDGET3D.getCamera=function(){return n},WIDGET3D.getCameraGroup=function(){return r},WIDGET3D.getProjector=function(){return s},WIDGET3D.getScene=function(){return i},WIDGET3D.isPluginInitialized=function(){return e},WIDGET3D.checkIfHits=function(e){var t=WIDGET3D.mouseCoordinates(e),n=new THREE.Vector3(t.x,t.y,1),r=WIDGET3D.getProjector().pickingRay(n,WIDGET3D.getCamera()),i=r.intersectObjects(WIDGET3D.getApplication().meshes_),s=!1,o=[];if(i.length>0){for(var u=0;u<i.length;++u)if(i[u].object.visible){s=i[u].object;var a=new THREE.Matrix4;a.getInverse(i[u].object.matrixWorld);var f=i[u].point.clone().applyProjection(a),l=WIDGET3D.findObject(s,e.type);l&&o.push(l)}return o}return!1},WIDGET3D.findObject=function(e,t){var n=WIDGET3D.getApplication();for(var r=0;r<n.childEvents_[t.toString()].length;++r)if(n.childEvents_[t.toString()][r].isVisible_&&e===n.childEvents_[t.toString()][r].mesh_)return n.childEvents_[t.toString()][r];return!1},WIDGET3D.THREE_Application=function(o){if(!e){var o=o||{};if(o.renderer)t=o.renderer;else{var u=o.width!==undefined?o.width:window.innerWidth,a=o.height!==undefined?o.height:window.innerHeight,f=o.antialias!==undefined?o.antialias:!0,l=o.domParent!==undefined?o.domParent:document.body;t=new THREE.WebGLRenderer({antialias:f}),t.setSize(u,a);var c=o.clearColor!==undefined?o.clearColor:3355443,h=o.opacity!==undefined?o.opacity:1;t.setClearColor(c,h),l.appendChild(t.domElement)}if(o.camera)n=o.camera;else{var p=o.aspect!==undefined?o.aspect:t.domElement.width/t.domElement.height,d=o.fov!==undefined?o.fov:50,v=o.near!==undefined?o.near:.1,m=o.far!==undefined?o.far:2e3;n=new THREE.PerspectiveCamera(d,p,v,m)}i=o.scene!==undefined?o.scene:new THREE.Scene;var g=!1;if(!WIDGET3D.isInitialized()){g=WIDGET3D.init({collisionCallback:{callback:WIDGET3D.checkIfHits},container:THREE.Object3D,canvas:t.domElement});if(!g)return console.log("Widget3D init failed!"),!1}else g=WIDGET3D.getApplication();return i.add(g.container_),s=new THREE.Projector,r=new WIDGET3D.CameraGroup({camera:n}),g.addChild(r),e=!0,g}return console.log("nothing to init"),WIDGET3D.getApplication()}}};THREEJS_WIDGET3D.createFunctions(),WIDGET3D.Basic.prototype.getPosition=function(){return this.mesh_.position},WIDGET3D.Basic.prototype.getPositionX=function(){return this.mesh_.position.x},WIDGET3D.Basic.prototype.getPositionY=function(){return this.mesh_.position.y},WIDGET3D.Basic.prototype.getPositionZ=function(){return this.mesh_.position.z},WIDGET3D.Basic.prototype.setPosition=function(e,t,n){this.mesh_.position.set(e,t,n)},WIDGET3D.Basic.prototype.setPositionX=function(e){this.mesh_.position.setX(e)},WIDGET3D.Basic.prototype.setPositionY=function(e){this.mesh_.position.setY(e)},WIDGET3D.Basic.prototype.setPositionZ=function(e){this.mesh_.position.setZ(e)},WIDGET3D.Basic.prototype.getRotation=function(){return this.mehs_.useQuaternion&&this.mesh_.rotation.setEulerFromQuaternion(this.mesh_.quaternion),this.mesh_.rotation},WIDGET3D.Basic.prototype.getRotationX=function(){return this.mehs_.useQuaternion&&this.mesh_.rotation.setEulerFromQuaternion(this.mesh_.quaternion),this.mesh_.rotation.x},WIDGET3D.Basic.prototype.getRotationY=function(){return this.mehs_.useQuaternion&&this.mesh_.rotation.setEulerFromQuaternion(this.mesh_.quaternion),this.mesh_.rotation.y},WIDGET3D.Basic.prototype.getRotationZ=function(){return this.mehs_.useQuaternion&&this.mesh_.rotation.setEulerFromQuaternion(this.mesh_.quaternion),this.mesh_.rotation.z},WIDGET3D.Basic.prototype.setRotation=function(e,t,n){this.mesh_.useQuaternion&&this.mesh_.quaternion.setFromEuler(new THREE.Vec3(e,t,n),this.mesh_.eulerOrder),this.mesh_.rotation.set(e,t,n)},WIDGET3D.Basic.prototype.setRotationX=function(e){if(this.mesh_.useQuaternion){var t=this.getRotationY(),n=this.getRotationZ();this.mesh_.quaternion.setFromEuler(new THREE.Vec3(e,t,n),this.mesh_.eulerOrder)}this.mesh_.rotation.setX(e)},WIDGET3D.Basic.prototype.setRotationY=function(e){if(this.mesh_.useQuaternion){var t=this.getRotationX(),n=this.getRotationZ();this.mesh_.quaternion.setFromEuler(new THREE.Vec3(t,e,n),this.mesh_.eulerOrder)}this.mesh_.rotation.setY(e)},WIDGET3D.Basic.prototype.setRotationZ=function(e){if(this.mesh_.useQuaternion){var t=this.getRotationX(),n=this.getRotationY();this.mesh_.quaternion.setFromEuler(new THREE.Vec3(t,n,e),this.mesh_.eulerOrder)}this.mesh_.rotation.setZ(e)},WIDGET3D.Basic.prototype.useQuaternion=function(){this.mesh_.useQuaternion=!0},WIDGET3D.Basic.prototype.setEulerOrder=function(e){this.mesh_.eulerOrder=e},WIDGET3D.Basic.prototype.applyMatrix=function(e){this.mesh_.applyMatrix(e)},WIDGET3D.Basic.prototype.rotateOnAxis=function(e,t){this.mesh_.rotateOnAxis(e,t)},WIDGET3D.Basic.prototype.translateOnAxis=function(e,t){this.mesh_.translateOnAxis(e,t)},WIDGET3D.Basic.prototype.translateX=function(e){this.mesh_.translateX(e)},WIDGET3D.Basic.prototype.translateY=function(e){this.mesh_.translateY(e)},WIDGET3D.Basic.prototype.translateZ=function(e){this.mesh_.translateZ(e)},WIDGET3D.Basic.prototype.localToWorld=function(){return this.mesh_.localToWorld()},WIDGET3D.Basic.prototype.worldToLocal=function(){return this.mesh_.worldToLocal()},WIDGET3D.Basic.prototype.lookAt=function(e){this.mesh_.lookAt(e)},WIDGET3D.Basic.prototype.updateMatrix=function(){this.mesh_.updateMatrix()},WIDGET3D.Basic.prototype.updateMatrixWorld=function(){this.mesh_.updateMatrixWorld()},WIDGET3D.Basic.prototype.computeBoundingBox=function(){return this.mesh_.geometry.computeBoundingBox(),this.getBoundingBox()},WIDGET3D.Basic.prototype.getBoundingBox=function(){return this.mesh_.geometry.boundingBox},WIDGET3D.Basic.prototype.computeBoundingSphere=function(){return this.mesh_.geometry.computeBoundingSphere(),this.getBoundingSphere()},WIDGET3D.Basic.prototype.getBoundingSphere=function(){return this.mesh_.geometry.boundingSphere},WIDGET3D.Group.prototype.getPosition=function(){return this.container_.position},WIDGET3D.Group.prototype.getPositionX=function(){return this.container_.position.x},WIDGET3D.Group.prototype.getPositionY=function(){return this.container_.position.y},WIDGET3D.Group.prototype.getPositionZ=function(){return this.container_.position.z},WIDGET3D.Group.prototype.setPosition=function(e,t,n){this.container_.position.set(e,t,n)},WIDGET3D.Group.prototype.setPositionX=function(e){this.container_.position.setX(e)},WIDGET3D.Group.prototype.setPositionY=function(e){this.container_.position.setY(e)},WIDGET3D.Group.prototype.setPositionZ=function(e){this.container_.position.setZ(e)},WIDGET3D.Group.prototype.getRotation=function(){return this.container_.useQuaternion&&this.container_.rotation.setEulerFromQuaternion(this.container_.quaternion),this.container_.rotation},WIDGET3D.Group.prototype.getRotationX=function(){return this.container_.useQuaternion&&this.container_.rotation.setEulerFromQuaternion(this.container_.quaternion),this.container_.rotation.x},WIDGET3D.Group.prototype.getRotationY=function(){return this.container_.useQuaternion&&this.container_.rotation.setEulerFromQuaternion(this.container_.quaternion),this.container_.rotation.y},WIDGET3D.Group.prototype.getRotation.z=function(){return this.container_.useQuaternion&&this.container_.rotation.setEulerFromQuaternion(this.container_.quaternion),this.container_.rotation.z},WIDGET3D.Group.prototype.setRotation=function(e,t,n){this.container_.useQuaternion&&this.container_.quaternion.setFromEuler(new THREE.Vec3(e,t,n),this.container_.eulerOrder),this.container_.rotation.set(e,t,n)},WIDGET3D.Group.prototype.setRotationX=function(e){if(this.container_.useQuaternion){var t=this.getRotationY(),n=this.getRotationZ();this.container_.quaternion.setFromEuler(new THREE.Vec3(e,t,n),this.container_.eulerOrder)}this.container_.rotation.setX(e)},WIDGET3D.Group.prototype.setRotationY=function(e){if(this.container_.useQuaternion){var t=this.getRotationX(),n=this.getRotationZ();this.container_.quaternion.setFromEuler(new THREE.Vec3(t,e,n),this.container_.eulerOrder)}this.container_.rotation.setY(e)},WIDGET3D.Group.prototype.setRotationZ=function(e){if(this.container_.useQuaternion){var t=this.getRotationX(),n=this.getRotationY();this.container_.quaternion.setFromEuler(new THREE.Vec3(t,n,e),this.container_.eulerOrder)}this.container_.rotation.setZ(e)},WIDGET3D.Group.prototype.useQuaternion=function(){this.container_.useQuaternion=!0},WIDGET3D.Group.prototype.setEulerOrder=function(e){this.container_.eulerOrder=e},WIDGET3D.Group.prototype.applyMatrix=function(e){this.container_.applyMatrix(e)},WIDGET3D.Group.prototype.rotateOnAxis=function(e,t){this.container_.rotateOnAxis(e,t)},WIDGET3D.Group.prototype.translateOnAxis=function(e,t){this.container_.translateOnAxis(e,t)},WIDGET3D.Group.prototype.translateX=function(e){this.container_.translateX(e)},WIDGET3D.Group.prototype.translateY=function(e){this.container_.translateY(e)},WIDGET3D.Group.prototype.translateZ=function(e){this.container_.translateZ(e)},WIDGET3D.Group.prototype.localToWorld=function(){return this.container_.localToWorld()},WIDGET3D.Group.prototype.worldToLocal=function(){return this.container_.worldToLocal()},WIDGET3D.Group.prototype.lookAt=function(e){this.container_.lookAt(e)},WIDGET3D.Group.prototype.updateMatrix=function(){this.container_.updateMatrix()},WIDGET3D.Group.prototype.updateMatrixWorld=function(){this.container_.updateMatrixWorld()},WIDGET3D.Group.prototype.computeBoundingBox=function(){var e=this.getBoundingSphere();return e==undefined&&(e=this.computeBoundingSphere()),this.boundingBox=e.getBoundingBox(),this.boundingBox},WIDGET3D.Group.prototype.getBoundingBox=function(){return this.boundingBox},WIDGET3D.Group.prototype.computeBoundingSphere=function(){var e=this.getPosition(),t=0;for(var n=0;n<this.children_.length;++n){var r=this.children_[n].computeBoundingSphere(),i=e.distanceTo(r.center)+r.radius;n==0&&(t=i),i>t&&(t=i)}return this.boundingSphere=new THREE.Sphere(e,t),this.boundingSphere},WIDGET3D.Group.prototype.getBoundingSphere=function(){return this.boundingSphere},WIDGET3D.GridWindow=function(e){var t=this;WIDGET3D.Group.call(this);var e=e||{};this.width_=e.width!==undefined?e.width:1e3,this.height_=e.height!==undefined?e.height:1e3,this.density_=e.density!==undefined?e.density:6,this.depth_=this.width_/this.density_,this.maxChildren_=this.density_*this.density_,this.color_=e.color!==undefined?e.color:7039851,this.lineWidth_=e.lineWidth!==undefined?e.lineWidth:2,this.opacity_=e.opacity!==undefined?e.opacity:.5,this.material_=new THREE.MeshBasicMaterial({color:this.color_,opacity:this.opacity_,wireframe:!0,side:THREE.DoubleSide,wireframeLinewidth:this.lineWidth_});var n=new THREE.CubeGeometry(this.width_,this.height_,this.depth_,this.density_,this.density_,1),r=new THREE.Mesh(n,this.material_);this.setMesh(r),this.defaultControls_=e.defaultControls!==undefined?e.defaultControls:!1;if(this.defaultControls_){var i=e.mouseButton!==undefined?e.mouseButton:0,s=e.shiftKey!==undefined?e.shiftKey:!1;this.controls_=new WIDGET3D.RollControls({component:this,mouseButton:i,shiftKey:s})}},WIDGET3D.GridWindow.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.GridWindow.prototype.addSlots=function(e){this.density_=e,this.maxChildren_=e*e,this.depth_=this.width_/this.density_;var t=new THREE.CubeGeometry(this.width_,this.height_,this.depth_,this.density_,this.density_,1),n=new THREE.Mesh(t,this.material_);this.setMesh(n);var r=this.children_;this.children_=[];for(var i=0;i<r.length;++i){var s=r[i];this.children_.push(s),s.width_=this.width_/(this.density_+3.3),s.height_=this.height_/(this.density_+3.3);var o=new THREE.CubeGeometry(s.width_,s.height_,s.depth_),u=new THREE.Mesh(o,s.material_);s.setMesh(u),s.setToPlace()}},WIDGET3D.GridIcon=function(e){WIDGET3D.Basic.call(this);var e=e||{},t=e.parent;if(t==undefined)return console.log("GridIcon needs to have grid window as parent!"),console.log("Parent has to be given in parameters."),!1;t.children_.length>=t.maxChildren_&&(console.log("Grid is full! Creating bigger one"),t.addSlots(Math.ceil(t.density_*1.5))),this.color_=e.color!==undefined?e.color:16777215,this.url_=e.url!==undefined?e.url:!1,this.img_=e.img!==undefined?e.img:!1,this.metadata_=e.metadata!==undefined?e.metadata:!1,this.width_=t.width_/(t.density_+3.3),this.height_=t.height_/(t.density_+3.3),this.depth_=e.depth!==undefined?e.depth:this.height_;var n=new THREE.CubeGeometry(this.width_,this.height_,this.depth_);this.texture_=!1,this.img_?(this.texture_=new THREE.Texture(this.img_),this.texture_.needsUpdate=!0):this.url_&&(this.texture_=THREE.ImageUtils.loadTexture(this.url_)),this.material_=new THREE.MeshBasicMaterial({map:this.texture_,color:this.color_});var r=new THREE.Mesh(n,this.material_);this.setMesh(r),t.addChild(this),this.setToPlace()},WIDGET3D.GridIcon.prototype=WIDGET3D.Basic.prototype.inheritance(),WIDGET3D.GridIcon.prototype.setToPlace=function(){var e=this.parent_.getPosition(),t=-this.parent_.width_/2+e.x/this.parent_.width_,n=this.parent_.height_/2+e.y/this.parent_.height_,r=this.parent_.width_/this.parent_.density_,i=this.parent_.height_/this.parent_.density_,s=r/2,o=i/2;if(this.parent_.children_.length-1>0){var u=this.parent_.children_[this.parent_.children_.length-2],a=u.getPosition();if((this.parent_.children_.length-1)%this.parent_.density_==0)var f=t+s,l=a.y-i;else var f=a.x+r,l=a.y}else var f=t+s,l=n-o;this.setPosition(f,l,e.z/this.parent_.height_)},WIDGET3D.TitledWindow=function(e){WIDGET3D.Group.call(this);var t=this,e=e||{};this.width_=e.width!==undefined?e.width:2e3,this.height_=e.height!==undefined?e.height:2e3;var n=e.title!==undefined?e.title:"title",r=e.color!==undefined?e.color:8421504,i=e.texture,s=e.material!==undefined?e.material:new THREE.MeshBasicMaterial({color:r,map:i,side:THREE.DoubleSide});this.title_={};var o=this.createTitle(n,s.side);this.setMesh(o),this.content_=new WIDGET3D.Basic;var u=new THREE.Mesh(new THREE.PlaneGeometry(this.width_,this.height_),s);this.content_.setMesh(u),this.addChild(this.content_),this.closeButton_=new WIDGET3D.Basic;var a=new THREE.Mesh(new THREE.PlaneGeometry(this.width_/10,this.height_/10),new THREE.MeshBasicMaterial({color:11141120,side:this.mesh_.material.side}));this.closeButton_.setMesh(a),this.closeButton_.setPosition(this.width_/2-this.width_/20,this.height_/2+this.height_/20,0),this.addChild(this.closeButton_);var f=function(e){return function(){e.remove()}},l=f(this);this.closeButton_.addEventListener("click",l),this.defaultControls_=e.defaultControls!==undefined?e.defaultControls:!1;if(this.defaultControls_){var c=e.mouseButton!==undefined?e.mouseButton:0,h=e.shiftKey!==undefined?e.shiftKey:!1,p=e.attached!==undefined?e.attached:!1,d=e.debug!==undefined?e.debug:!1;this.controls_=new WIDGET3D.DragControls({debug:d,component:this,mouseButton:c,shiftKey:h,width:this.width_*2,height:(this.height_+this.title_.height_)*2}),this.start_=!1}},WIDGET3D.TitledWindow.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.TitledWindow.prototype.createTitle=function(e,t){this.textureCanvas_=document.createElement("canvas"),this.textureCanvas_.width=512,this.textureCanvas_.height=128,this.textureCanvas_.style.display="none",document.body.appendChild(this.textureCanvas_),this.setTitle(e);var n=new THREE.Texture(this.textureCanvas_);n.needsUpdate=!0;var r=new THREE.MeshBasicMaterial({map:n,side:t});this.title_.width_=this.width_-this.width_/10,this.title_.height_=this.height_/10;var i=new THREE.Mesh(new THREE.PlaneGeometry(this.title_.width_,this.title_.height_),r);return i.position.y=this.height_/2+this.height_/20,i.position.x=(this.width_-this.width_/10)/2-this.width_/2,i},WIDGET3D.TitledWindow.prototype.setTitle=function(e){var t=this.textureCanvas_.getContext("2d");t.fillStyle="#B3B3B3",t.fillRect(0,0,this.textureCanvas_.width,this.textureCanvas_.height),t.fillStyle="#000000",t.font="bold 60px Courier New",t.align="center",t.textBaseline="middle",t.fillText(e,10,this.textureCanvas_.height/2)},WIDGET3D.TitledWindow.prototype.updateTitle=function(e){this.setTitle(e),this.mesh_.material.map.needsUpdate=!0},WIDGET3D.TitledWindow.prototype.remove=function(){this.hide();var e=this.textureCanvas_;document.body.removeChild(e),this.defaultControls_&&this.controls_.remove(),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.TitledWindow.prototype.getContent=function(){return this.content_},WIDGET3D.Dialog=function(e){WIDGET3D.Group.call(this);var e=e||{};this.width_=e.width!==undefined?e.width:1e3,this.height_=e.height!==undefined?e.height:1e3,this.depth_=e.depth!==undefined?e.depth:20,this.color_=e.color!==undefined?e.color:12636368,this.opacity_=e.opacity!==undefined?e.opacity:.9,this.title_=e.title!==undefined?e.title:"This is a dialog",this.fields_=e.fields!==undefined?e.fields:[],this.buttons_=e.buttons!==undefined?e.buttons:[],this.hasCancel_=e.hasCancel!==undefined?e.hasCancel:!1;if(this.hasCancel_){this.cancelText_=e.cancelText!==undefined?e.cancelText:"Cancel";var t=function(e){return function(){e.remove()}};this.buttons_.push({text:this.cancelText_,onclick:t(this)})}this.componentHeight_=this.height_/((this.fields_.length+3)*1.3),this.createDialogTitle(),this.createButtons(),this.createTextfields()},WIDGET3D.Dialog.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.Dialog.prototype.createDialogTitle=function(){this.canvas_=document.createElement("canvas"),this.canvas_.width=512,this.canvas_.height=512,this.canvas_.style.display="none",document.body.appendChild(this.canvas_);var e=this.canvas_.getContext("2d");e.fillStyle="#FFFFFF",e.fillRect(0,0,this.canvas_.width,this.canvas_.height),e.fillStyle="#000000",e.font="bold 30px Courier New",e.align="center",e.textBaseline="middle";var t=e.measureText(this.title_).width,n=e.measureText(this.title_).height;e.fillText(this.title_,this.canvas_.width/2-t/2,30);var r=new THREE.Texture(this.canvas_);r.needsUpdate=!0;var i=new Array;i.push(new THREE.MeshBasicMaterial({color:this.color_,opacity:this.opacity_})),i.push(new THREE.MeshBasicMaterial({map:r,color:this.color_,opacity:this.opacity_}));var s=new THREE.CubeGeometry(this.width_,this.height_,this.depth_*.75);for(var o=0;o<s.faces.length;o++){var u=s.faces[o];o===4||o==5?u.materialIndex=1:u.materialIndex=0}s.materials=i;var a=new THREE.MeshFaceMaterial(i),f=new THREE.Mesh(s,a);this.setMesh(f),this.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault()},!1)},WIDGET3D.Dialog.prototype.createButtons=function(){var e=this.width_/(this.buttons_.length+2),t=this.componentHeight_,n=-this.width_/2,r=-this.height_/2+1,i=this.width_/this.buttons_.length,s=i/2,o=r+t/2,u=0;for(var a=0;a<this.buttons_.length;++a){var f=document.createElement("canvas");f.width=512,f.height=128,f.style.display="none",document.body.appendChild(f),this.buttons_[a].canvas=f;var l=f.getContext("2d");l.fillStyle="#B3B3B3",l.fillRect(0,0,f.width,f.height),l.fillStyle="#000000",l.font="bold 60px Courier New",l.align="center",l.textBaseline="middle";var c=l.measureText(this.buttons_[a].text).width;l.fillText(this.buttons_[a].text,f.width/2-c/2,f.height/2);var h=new THREE.Texture(f);h.needsUpdate=!0;var p=new THREE.MeshBasicMaterial({map:h}),d=new THREE.CubeGeometry(e,t,this.depth_),v=this.createFaceMaterialsMesh(p,d),m=new WIDGET3D.Basic;m.setMesh(v),m.addEventListener("click",this.buttons_[a].onclick,!1),this.addChild(m);if(a==0)var g=n+s;else var g=u+i;m.setPosition(g,o,this.getPosition().z),u=g}},WIDGET3D.Dialog.prototype.createTextfields=function(){var e=function(e){return function(t){t.stopPropagation(),t.preventDefault(),WIDGET3D.unfocusFocused(),e.focus()}},t=function(e){return function(t){t.stopPropagation();if(t.charCode!=0){var n=String.fromCharCode(t.charCode);e.addLetter(n)}else t.type=="keydown"&&(t.keyCode==8||t.keyCode==46)&&e.erase(1)}},n=function(e,t,n){return function(){var r=e.getContext("2d");r.fillStyle="#FFFFFF",r.fillRect(0,0,e.width,e.height),r.fillStyle="#000000",r.font="bold 50px Courier New",r.align="center",r.textBaseline="middle",r.fillText(t.textHandle_,5,e.height/2),n.needsUpdate=!0}},r=this.width_/2.5,i=this.componentHeight_,s=-this.width_/2,o=this.width_/2,u=this.height_/2-i,a=(this.height_-2*i)/this.fields_.length,f=a/2,l=o-r/1.5,c=s+r/1.5,h=0;for(var p=0;p<this.fields_.length;++p){var d=document.createElement("canvas");d.width=512,d.height=128,d.style.display="none",document.body.appendChild(d),this.fields_[p].canvas1=d;var v=new THREE.Texture(d),m=new THREE.MeshBasicMaterial({map:v}),g=new THREE.CubeGeometry(r,i,this.depth_),y=this.createFaceMaterialsMesh(m,g),b=new WIDGET3D.Text({maxLength:this.fields_[p].maxLength});b.setText(""),b.setMesh(y),b.addEventListener("click",e(b),!1),b.addEventListener("keypress",t(b)),b.addEventListener("keydown",t(b)),b.addUpdateCallback(n(d,b,v)),this.addChild(b);var w=document.createElement("canvas");w.width=512,w.height=128,w.style.display="none",document.body.appendChild(w),this.fields_[p].canvas2=w;var E=w.getContext("2d");E.fillStyle="#FFFFFF",E.fillRect(0,0,w.width,w.height),E.fillStyle="#000000",E.font="bold 60px Courier New",E.align="center",E.textBaseline="middle";var S=E.measureText(this.fields_[p].description).width;E.fillText(this.fields_[p].description,w.width/2-S/2,w.height/2);var x=new THREE.Texture(w);x.needsUpdate=!0;var T=new THREE.MeshBasicMaterial({map:x,color:this.color_,opacity:this.opacity_}),N=new THREE.CubeGeometry(r,i,this.depth_),C=this.createFaceMaterialsMesh(T,N),k=new WIDGET3D.Basic;k.setMesh(C),this.addChild(k);if(p==0)var L=u-f;else var L=h-a;b.setPosition(l,L,this.getPosition().z),k.setPosition(c,L,this.getPosition().z),h=L}},WIDGET3D.Dialog.prototype.createFaceMaterialsMesh=function(e,t){var n=new Array;n.push(new THREE.MeshBasicMaterial({color:this.color_,opacity:this.opacity_})),n.push(e);for(var r=0;r<t.faces.length;r++){var i=t.faces[r];r===4||r==5?i.materialIndex=1:i.materialIndex=0}t.materials=n;var s=new THREE.MeshFaceMaterial(n),o=new THREE.Mesh(t,s);return o},WIDGET3D.Dialog.prototype.remove=function(){for(var e=0;e<this.buttons_.length;++e)document.body.removeChild(this.buttons_[e].canvas);for(var t=0;t<this.fields_.length;++t)document.body.removeChild(this.fields_[t].canvas1),document.body.removeChild(this.fields_[t].canvas2);document.body.removeChild(this.canvas_),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.SelectDialog=function(e){WIDGET3D.Group.call(this);var e=e||{};this.width_=e.width!==undefined?e.width:1e3,this.height_=e.height!==undefined?e.height:1e3,this.depth_=e.depth!==undefined?e.depth:10,this.color_=e.color!==undefined?e.color:12636368,this.opacity_=e.opacity!==undefined?e.opacity:.9,this.choices_=e.choices!==undefined?e.choices:[],this.hasCancel_=e.hasCancel!==undefined?e.hasCancel:!1,this.text_=e.text!==undefined?e.text:!1;if(this.hasCancel_){this.cancelText_=e.cancelText!==undefined?e.cancelText:"Cancel";var t=function(e){return function(){e.remove()}},n=t(this);this.choices_.push({string:this.cancelText_,onclick:{handler:n}})}this.text_?this.createText():this.choiceHeight_=this.height_/(this.choices_.length*1.2),this.choiceCanvases_=[],this.createChoises()},WIDGET3D.SelectDialog.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.SelectDialog.prototype.createText=function(){this.textCanvas_=document.createElement("canvas"),this.textCanvas_.width=512,this.textCanvas_.height=128,this.textCanvas_.style.display="none",document.body.appendChild(this.textCanvas_);var e=this.textCanvas_.getContext("2d");this.choiceHeight_=this.height_/((this.choices_.length+1)*1.2);var t=this.createTitle(this.text_,e,this.textCanvas_);t.position.y=this.height_*.5-this.choiceHeight_*.5,this.setMesh(t),this.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault()},!1)},WIDGET3D.SelectDialog.prototype.createChoises=function(){var e=0;for(var t=0;t<this.choices_.length;++t){var n=new WIDGET3D.Basic,r=document.createElement("canvas");this.choiceCanvases_.push(r),r.width=512,r.height=128,r.style.display="none",document.body.appendChild(r);var i=r.getContext("2d"),s=this.width_/1.2,o=this.choiceHeight_,u=this.createButtonMaterial(this.choices_[t].string,i,r),a=new THREE.CubeGeometry(s,o,this.depth_);for(var f=0;f<a.faces.length;f++){var l=a.faces[f];f===4||f==5?l.materialIndex=1:l.materialIndex=0}a.materials=u;var c=new THREE.MeshFaceMaterial(u),h=new THREE.Mesh(a,c);n.setMesh(h);var p=this.getPosition(),d=0;t==0?this.text_?d=this.height_*.5-o*1.7:d=this.height_*.5-o*.5:d=e-1.2*o,e=d,n.setPosition(p.x,d,p.z),n.addEventListener("click",this.choices_[t].onclick.handler,!1),n.menuID_=t,this.addChild(n)}},WIDGET3D.SelectDialog.prototype.createButtonMaterial=function(e,t,n){t.fillStyle="#FFFFFF",t.fillRect(0,0,n.width,n.height),t.fillStyle="#000000",t.font="bold 40px Courier New",t.align="center",t.textBaseline="middle";var r=t.measureText(e).width;t.fillText(e,n.width/2-r/2,n.height/2);var i=new THREE.Texture(n);i.needsUpdate=!0;var s=new Array;return s.push(new THREE.MeshBasicMaterial({color:this.color_,opacity:this.opacity_})),s.push(new THREE.MeshBasicMaterial({map:i,color:this.color_,opacity:this.opacity_})),s},WIDGET3D.SelectDialog.prototype.createTitle=function(e,t,n){t.fillStyle="#FFFFFF",t.fillRect(0,0,n.width,n.height),t.fillStyle="#000000",t.font="bold 45px Courier New",t.align="center",t.textBaseline="middle";var r=t.measureText(e).width;t.fillText(e,n.width/2-r/2,n.height/2);var i=new THREE.Texture(n);i.needsUpdate=!0;var s=new Array;s.push(new THREE.MeshBasicMaterial({color:this.color_,opacity:this.opacity_})),s.push(new THREE.MeshBasicMaterial({map:i,color:this.color_,opacity:this.opacity_}));var o=new THREE.CubeGeometry(this.width_,this.choiceHeight_,this.depth_);for(var u=0;u<o.faces.length;u++){var a=o.faces[u];u===4||u===5?a.materialIndex=1:a.materialIndex=0}o.materials=s;var f=new THREE.MeshFaceMaterial(s),l=new THREE.Mesh(o,f);return l},WIDGET3D.SelectDialog.prototype.changeChoiceText=function(e,t){var n=!1;for(var r=0;r<this.children_.length;++r)if(this.children_[r].menuID_==t){n=this.children_[r];break}if(n){var i=n.mesh_.material.map.image,s=n.mesh_.material.map.image.getContext("2d"),o=this.createButtonMaterial(e,s,i);return n.mesh_.geometry.materials=o,n.mesh_.material=new THREE.MeshFaceMaterial(o),n.mesh_.needsUpdate=!0,!0}return!1},WIDGET3D.SelectDialog.prototype.remove=function(){for(var e=0;e<this.choiceCanvases_.length;++e)t=this.choiceCanvases_[e],document.body.removeChild(t);this.choiceCanvases_=null;var t=this.textCanvas_;document.body.removeChild(t),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.DragControls=function(e){var t=this;t.setPlaneRotation=function(){var e=t.camera_.rotation.clone(),n=t.camera_.parent;while(n!=undefined&&n!=t.component_.parent)e.add(n.rotation.clone()),n=n.parent;t.plane_.rotation.copy(e)},t.component_=e.component,t.mouseButton_=e.mouseButton!==undefined?e.mouseButton:0,t.shiftKey_=e.shiftKey!==undefined?e.shiftKey:!1,t.camera_=WIDGET3D.getCamera();var n=e.width!==undefined?e.width:2e3,r=e.height!==undefined?e.height:2e3,i=e.debug!==undefined?e.debug:!1;t.drag_=!1,t.offset_=new THREE.Vector3,t.plane_=new THREE.Mesh(new THREE.PlaneGeometry(n,r,8,8),new THREE.MeshBasicMaterial({color:0,opacity:.25,transparent:!0,wireframe:!0,side:THREE.DoubleSide})),t.plane_.visible=i,t.setPlaneRotation(),WIDGET3D.getScene().add(t.plane_),t.mouseupHandler=function(e){t.drag_&&(t.drag_=!1,t.plane_.position.copy(t.component_.parent_.container_.localToWorld(t.component_.getPosition().clone())),WIDGET3D.getApplication().removeEventListener("mousemove",t.mousemoveHandler),WIDGET3D.getApplication().removeEventListener("mouseup",t.mouseupHandler))},t.mousedownHandler=function(e){if(e.button===t.mouseButton_&&e.shiftKey===t.shiftKey_){t.start_=!0;if(!t.drag_){t.setPlaneRotation(),t.plane_.position.copy(t.component_.parent_.container_.localToWorld(t.component_.getPosition().clone())),t.plane_.updateMatrixWorld(!0);var n=WIDGET3D.mouseCoordinates(e),r=new THREE.Vector3(n.x,n.y,1),i=WIDGET3D.getProjector().pickingRay(r,t.camera_),s=i.intersectObject(t.plane_);s.length>0&&t.offset_.copy(s[0].point).sub(t.plane_.position),WIDGET3D.getApplication().addEventListener("mousemove",t.mousemoveHandler,!1),WIDGET3D.getApplication().addEventListener("mouseup",t.mouseupHandler,!1),t.component_.focus(),t.drag_=!0}}},t.mousemoveHandler=function(e){if(t.drag_){var n=WIDGET3D.mouseCoordinates(e),r=new THREE.Vector3(n.x,n.y,1),i=WIDGET3D.getProjector().pickingRay(r,t.camera_),s=i.intersectObject(t.plane_);if(s.length>0){var o=s[0].point.sub(t.offset_);t.plane_.position.copy(o);var u=t.component_.parent_.container_.worldToLocal(o);t.component_.setPosition(u.x,u.y,u.z)}}},t.component_.addEventListener("mousedown",t.mousedownHandler,!1),t.remove=function(){WIDGET3D.getScene().remove(t.plane_),t.plane_.geometry.dispose(),t.plane_.material.dispose(),t.plane_=undefined}}