/*!
Copyright (C) 2012 Anna-Liisa Mattila / Deparment of Pervasive Computing, Tampere University of Technology

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

*/
WIDGET3D={ElementType:{APPLICATION:0,GROUP:1,BASIC:2,TEXT:3,UNDEFINED:666},createFunctions:function(){var e=[],t={},n,r,i,s,o=!1,u=function(){var e=0;return function(){return++e}};WIDGET3D.id=u(),WIDGET3D.getEvents=function(){return i},WIDGET3D.getCanvas=function(){return s},WIDGET3D.getApplication=function(){return n},WIDGET3D.addObject=function(e){t[e.id]=e},WIDGET3D.removeObject=function(e){delete t[e]},WIDGET3D.getObjectById=function(e){return t[e]},WIDGET3D.getAllObjects=function(){return t},WIDGET3D.getFocused=function(){return e},WIDGET3D.addFocus=function(t){e.push(t)},WIDGET3D.removeFocus=function(t){for(var n=0;n<e.length;++n)if(e[n]===t)return e.splice(n,1),!0;return!1},WIDGET3D.unfocusFocused=function(){for(var t=0;t<e.length;++t)e[t].unfocus();e=[]},WIDGET3D.isInitialized=function(){return o},WIDGET3D.init=function(e){var e=e||{};return e.container==undefined?(console.log("Container must be specified!"),console.log("Container has to be constructor method of container of used 3D-engine (eg. in three.js THREE.Object3D"),console.log("Initializing WIDGET3D failed!"),!1):(WIDGET3D.Container=e.container,e.canvas==undefined?(console.log("Canvas must be specified!"),console.log("Initializing WIDGET3D failed!"),!1):(s=e.canvas,n=new WIDGET3D.Application,e.collisionCallback==undefined||e.collisionCallback.callback==undefined?(console.log("CollisionCallback has to be JSON object containing attributes callback (and args, optional)"),console.log("Initializing WIDGET3D failed!"),!1):(i=new WIDGET3D.DomEvents(e.collisionCallback),o=!0,n)))}}},WIDGET3D.createFunctions(),WIDGET3D.getRealWidth=function(){return parseInt(window.getComputedStyle(WIDGET3D.getCanvas(),null).getPropertyValue("width"))},WIDGET3D.getRealHeight=function(){return parseInt(window.getComputedStyle(WIDGET3D.getCanvas(),null).getPropertyValue("height"))},WIDGET3D.getCanvasWidth=function(){return WIDGET3D.getCanvas().width},WIDGET3D.getCanvasHeight=function(){return WIDGET3D.getCanvas().height},WIDGET3D.mouseScreenCoordinates=function(e){var t={x:0,y:0};if(!e)e=window.event,t.x=e.x,t.y=e.y;else{var n=e.target,r=0,i=0;while(n.offsetParent)r+=n.offsetLeft,i+=n.offsetTop,n=n.offsetParent;t.x=e.pageX-r,t.y=e.pageY-i}return t},WIDGET3D.mouseCoordinates=function(e){var t=WIDGET3D.mouseScreenCoordinates(e),n=WIDGET3D.getRealWidth(),r=WIDGET3D.getRealHeight(),i={minX:0,maxX:n,minY:0,maxY:r},s=WIDGET3D.scaleCoordinates(t,i);return s},WIDGET3D.scaleCoordinates=function(e,t){var n=+((e.x-t.minX)/t.maxX)*2-1,r=-((e.y-t.minY)/t.maxY)*2+1;return{x:n,y:r}},WIDGET3D.calculateLimits=function(e,t,n){var r=e.x+t/2,i=e.x-t/2,s=e.y+n/2,o=e.y-n/2;return{minX:i,maxX:r,minY:o,maxY:s}},WIDGET3D.DomEvents=function(e){var t=this,n={callback:e.callback,args:e.args};t.enabled={},t.mainEventHandler=function(e){var n=Object.getPrototypeOf(e);if(n.hasOwnProperty(String("initMouseEvent")))return t.mouseEvent(e),!1;if(n.hasOwnProperty(String("initKeyboardEvent")))return t.keyboardEvent(e);t.triggerEvent(e)},t.mouseEvent=function(e){var t=n.callback(e,n.args),r=e.type,i=WIDGET3D.getApplication(),s=!0;for(var o=0;o<t.length;++o){var u=t[o];if(u&&u.events.hasOwnProperty(r.toString()))for(var a=0;a<u.events[r.toString()].length;++a)u.events[r.toString()][a].bubbles||(s=!1),u.events[r.toString()][a].callback(e);if(!s)break}if(s&&i.events.hasOwnProperty(r.toString()))for(var f=0;f<i.events[r.toString()].length;++f)i.events[r.toString()][f].bubbles||(s=!1),i.events[r.toString()][f].callback(e);return s},t.keyboardEvent=function(e){var t=e.type,n=WIDGET3D.getApplication();for(var r=0;r<n.childEvents[t.toString()].length;++r)if(n.childEvents[t.toString()][r]!=n&&n.childEvents[t.toString()][r].inFocus){var i=n.childEvents[t.toString()][r];for(var s=0;s<i.events[t.toString()].length;++s)i.events[t.toString()][s].callback(e)}if(!n.inFocus&&n.events.hasOwnProperty(t.toString()))for(var o=0;o<n.events[t.toString()].length;++o)n.events[t.toString()][o].callback(e)},t.triggerEvent=function(e,t){var n=e.type;if(!t){var r=WIDGET3D.getApplication();for(var i=0;i<r.childEvents[n.toString()].length;++i){var s=r.childEvents[n.toString()][i];for(var o=0;o<s.events[n.toString()].length;++o)s.events[n.toString()][o].callback(e)}}else{var u=WIDGET3D.getObjectById(t);for(var a=0;a<u.events[n.toString()].length;++a)u.events[n.toString()][a].callback(e)}}},WIDGET3D.DomEvents.prototype.enableEvent=function(e){if(!this.enabled.hasOwnProperty(e.toString())||this.enabled.hasOwnProperty(e.toString())&&this.enabled[e.toString()]===!1)window.addEventListener(e,this.mainEventHandler,!1),this.enabled[e.toString()]=!0},WIDGET3D.DomEvents.prototype.disableEvent=function(e){return this.enabled.hasOwnProperty(e.toString())&&this.enabled[e.toString()]===!0?(window.removeEventListener(e,this.mainEventHandler,!1),this.enabled[e.toString()]=!1,!0):!1},WIDGET3D.GuiObject=function(){this.inFocus=!1,this.id=WIDGET3D.id(),this.updateCallbacks=[],this.events={checkEvent:function(e){return this.hasOwnProperty(e.toString())&&this[e.toString()]!=0?!0:!1},addCallback:function(e,t,n,r){if(!this.hasOwnProperty(e.toString())||this.hasOwnProperty(e.toString())&&this[e.toString()]===!1)this[e.toString()]=[];this[e.toString()].push({callback:t,bubbles:n,index:r})},removeCallback:function(e,t){if(this.hasOwnProperty(e.toString())&&Object.prototype.toString.apply(this[e.toString()])==="[object Array]")for(var n=0;n<this[e.toString()].length;++n)if(this[e.toString()][n].callback===t){var r=this[e.toString()][n].index;return this[e.toString()].splice(n,1),this[e.toString()].length==0&&(this[e.toString()]=!1),r}return!1},removeAll:function(e){if(this.hasOwnProperty(e.toString())&&Object.prototype.toString.apply(this[e.toString()])==="[object Array]"){var t=this[e.toString()][0].index;return this[e.toString()]=!1,t}return!1},remove:function(){var e=[];for(listener in this)if(this.hasOwnProperty(listener)&&Object.prototype.toString.apply(this[listener])==="[object Array]"){var t={name:listener,index:this[listener][0].index};e.push(t),listener=!1}return e}},WIDGET3D.addObject(this)},WIDGET3D.GuiObject.prototype.focus=function(){this.inFocus||(this.inFocus=!0,WIDGET3D.addFocus(this))},WIDGET3D.GuiObject.prototype.unfocus=function(){this.inFocus&&(this.inFocus=!1,WIDGET3D.removeFocus(this))},WIDGET3D.GuiObject.prototype.addEventListener=function(e,t,n){WIDGET3D.getEvents().enabled[e.toString()]||WIDGET3D.getEvents().enableEvent(e);if(!this.events.checkEvent(e))var r=WIDGET3D.getApplication().childEvents.addObject(e,this);else var r=this.events[e.toString()][0].index;n==undefined&&(n=!0),this.events.addCallback(e,t,n,r)},WIDGET3D.GuiObject.prototype.removeEventListener=function(e,t){var n=this.events.removeCallback(e,t);if(n===!1)return!1;if(this.events[e.toString()]===!1){var r=WIDGET3D.getApplication();r.childEvents[e.toString()].splice(n,1),r.childEvents[e.toString()].length==0&&r.childEvents.removeEvent(e);for(var i=0;i<r.childEvents[e.toString()].length;++i)r.childEvents[e.toString()][i].setNewEventIndex(e,i);return!0}},WIDGET3D.GuiObject.prototype.removeEventListeners=function(e){var t=this.events.removeAll(e);if(t===!1)return!1;var n=WIDGET3D.getApplication();n.childEvents[e.toString()].splice(t,1),n.childEvents[e.toString()].length==0&&n.childEvents.removeEvent(e);for(var r=0;r<n.childEvents[e.toString()].length;++r)n.childEvents[e.toString()][r].setNewEventIndex(e,r);return!0},WIDGET3D.GuiObject.prototype.removeAllListeners=function(){var e=this.events.remove(),t=WIDGET3D.getApplication();for(var n=0;n<e.length;++n){var r=e[n].name,i=e[n].index;t.childEvents[r].splice(i,1),t.childEvents[r].length==0&&t.childEvents.removeEvent(r);for(var s=0;s<t.childEvents[r].length;++s)t.childEvents[r][s].setNewEventIndex(r,s)}},WIDGET3D.GuiObject.prototype.setNewEventIndex=function(e,t){for(var n=0;n<this.events[e.toString()].length;++n)this.events[e.toString()][n].index=t;WIDGET3D.getApplication().childEvents[e.toString()][t]=this},WIDGET3D.GuiObject.prototype.addUpdateCallback=function(e,t){this.updateCallbacks.push({callback:e,arguments:t})},WIDGET3D.GuiObject.prototype.update=function(){for(var e=0;e<this.updateCallbacks.length;++e)this.updateCallbacks[e].callback(this.updateCallbacks[e].arguments)},WIDGET3D.GuiObject.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.Basic=function(){WIDGET3D.GuiObject.call(this),this.container,this.parent,this.isVisible=!0},WIDGET3D.Basic.prototype=WIDGET3D.GuiObject.prototype.inheritance(),WIDGET3D.Basic.prototype.type=WIDGET3D.ElementType.BASIC,WIDGET3D.Basic.prototype.setMesh=function(e){e.visible=this.isVisible,this.container&&this.parent?(this.parent.container.remove(this.container),this.container=e,this.parent.container.add(this.container)):this.parent?(this.container=e,this.parent.container.add(this.container)):this.container=e},WIDGET3D.Basic.prototype.show=function(){this.isVisible||(this.isVisible=!0,this.container.visible=!0)},WIDGET3D.Basic.prototype.hide=function(){this.isVisible&&(this.isVisible=!1,this.container.visible=!1,this.inFocus&&this.unfocus())},WIDGET3D.Basic.prototype.remove=function(){this.hide(),this.removeAllListeners(),this.parent.removeFromObjects(this),WIDGET3D.removeObject(this.id)},WIDGET3D.Basic.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.GroupBase=function(){this.children=[],this.container=new WIDGET3D.Container},WIDGET3D.GroupBase.prototype.add=function(e){e.parent!=undefined&&(e.parent!=WIDGET3D.getApplication()&&e.parent.removeRelatedEventListeners(e),e.parent.container.remove(e.container),e.parent.removeFromObjects(e)),e.parent=this,this.children.push(e),this.container.add(e.container)},WIDGET3D.GroupBase.prototype.hideNotFocused=function(){for(var e=0;e<this.children.length;++e)this.children[e].inFocus||this.children[e].hide()},WIDGET3D.GroupBase.prototype.removeFromObjects=function(e){for(var t=0;t<this.children.length;++t)if(this.children[t]===e){var n=this.children.splice(t,1);return this.container.remove(e.container),n[0]}return!1},WIDGET3D.Application=function(){WIDGET3D.GuiObject.call(this),WIDGET3D.GroupBase.call(this),this.childEvents={addObject:function(e,t){if(!this.hasOwnProperty(e.toString())||this.hasOwnProperty(e.toString())&&this[e.toString()]==0)this[e.toString()]=[];this[e.toString()].push(t);var n=this[e.toString()].length-1;return n},removeEvent:function(e){return this.hasOwnProperty(e.toString())&&this[e.toString()].length==0?(this[e.toString()]=!1,WIDGET3D.getEvents().disableEvent(e),!0):!1}}},WIDGET3D.Application.prototype=WIDGET3D.GuiObject.prototype.inheritance(),WIDGET3D.Application.prototype.add=WIDGET3D.GroupBase.prototype.add,WIDGET3D.Application.prototype.hideNotFocused=WIDGET3D.GroupBase.prototype.hideNotFocused,WIDGET3D.Application.prototype.removeFromObjects=WIDGET3D.GroupBase.prototype.removeFromObjects,WIDGET3D.Application.prototype.type=WIDGET3D.ElementType.APPLICATION,WIDGET3D.Group=function(){WIDGET3D.GuiObject.call(this),WIDGET3D.GroupBase.call(this),this.parent,this.isVisible=!0},WIDGET3D.Group.prototype=WIDGET3D.Basic.prototype.inheritance(),WIDGET3D.Group.prototype.hideNotFocused=WIDGET3D.GroupBase.prototype.hideNotFocused,WIDGET3D.Group.prototype.removeFromObjects=WIDGET3D.GroupBase.prototype.removeFromObjects,WIDGET3D.Group.prototype.type=WIDGET3D.ElementType.GROUP,WIDGET3D.Group.prototype.add=function(e){WIDGET3D.GroupBase.prototype.add.call(this,e),this.addRelatedEventListeners(e)},WIDGET3D.Group.prototype.show=function(){if(!this.isVisible){for(var e=0;e<this.children.length;++e)this.children[e].show();this.isVisible=!0}},WIDGET3D.Group.prototype.hide=function(){if(this.isVisible){for(var e=0;e<this.children.length;++e)this.children[e].hide();this.isVisible=!1,this.inFocus&&this.unfocus()}},WIDGET3D.Group.prototype.remove=function(){while(this.children.length>0)this.children[0].remove();this.hide(),this.removeAllListeners(),this.parent.removeFromObjects(this),WIDGET3D.removeObject(this.id)},WIDGET3D.Group.prototype.addEventListener=function(e,t,n){WIDGET3D.GuiObject.prototype.addEventListener.call(this,e,t,n);for(var r=0;r<this.children.length;++r)this.children[r].addEventListener(e,t,n)},WIDGET3D.Group.prototype.removeEventListener=function(e,t){WIDGET3D.GuiObject.prototype.removeEventListener.call(this,e,t);for(var n=0;n<this.children.length;++n)this.children[n].removeEventListener(e,t)},WIDGET3D.Group.prototype.removeEventListeners=function(e){for(var t=0;t<this.events[e].length;++t){var n=this.events[e][t].callback;for(var r=0;r<this.children.length;++r)this.children[t].removeEventListener(e,n)}WIDGET3D.GuiObject.prototype.removeEventListeners.call(this,e)},WIDGET3D.Group.prototype.removeAllListeners=function(){for(listener in this.events)if(this.events.hasOwnProperty(listener)&&Object.prototype.toString.apply(this.events[listener])==="[object Array]"){var e=listener;for(var t=0;t<this.events[listener].length;++t){var n=this.events[listener][t].callback;for(var r=0;r<this.children.length;++r)this.children[t].removeEventListener(e,n)}}WIDGET3D.GuiObject.prototype.removeAllListeners.call(this)},WIDGET3D.Group.prototype.removeRelatedEventListeners=function(e){for(listener in this.events)if(this.events.hasOwnProperty(listener)&&Object.prototype.toString.apply(this.events[listener])==="[object Array]"){var t=listener;for(var n=0;n<this.events[listener].length;++n){var r=this.events[listener][n].callback;e.removeEventListener(t,r)}}},WIDGET3D.Group.prototype.addRelatedEventListeners=function(e){for(listener in this.events)if(this.events.hasOwnProperty(listener)&&Object.prototype.toString.apply(this.events[listener])==="[object Array]"){var t=listener;for(var n=0;n<this.events[listener].length;++n){var r=this.events[listener][n].callback,i=this.events[listener][n].bubbles;e.addEventListener(t,r)}}},WIDGET3D.Group.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.Text=function(e){WIDGET3D.Basic.call(this);var e=e||{};this.mutable=e.mutable!==undefined?e.mutable:!0,this.cursor=e.cursor!==undefined?e.cursor:"|",this.maxLength=e.maxLength!==undefined?e.maxLength:!1,this.maxLineLength=e.maxLineLength!==undefined?e.maxLineLength:this.maxLength,this.endl="\n",this.currentRow="",this.text="",this.rows=[],this.textHandle=this.text,e.text&&this.setText(e.text)},WIDGET3D.Text.prototype=WIDGET3D.Basic.prototype.inheritance(),WIDGET3D.Text.prototype.type=WIDGET3D.ElementType.TEXT,WIDGET3D.Text.prototype.setText=function(e){if(this.mutable){for(var t=0;t<e.length;++t)this.addLetter(e[t]);this.update()}},WIDGET3D.Text.prototype.addLetter=function(e){if(this.mutable){if(!this.maxLength||this.text.length<this.maxLength)if(!this.maxLineLength||this.currentRow.length<this.maxLineLength){this.currentRow+=e,this.text+=e;if(this.currentRow.length==this.maxLineLength||this.text.length==this.maxLength)this.rows.push(this.currentRow+this.endl),this.currentRow=""}else if(this.currentRow.length==this.maxLineLength||this.text.length==this.maxLength)this.rows.push(this.currentRow+this.endl),this.currentRow=e,this.text+=e;this.textHandle=this.text,this.inFocus&&(this.textHandle+=this.cursor),this.update()}},WIDGET3D.Text.prototype.erase=function(e){if(this.mutable){for(i=0;i<e;++i)this.currentRow.length!=0?(this.currentRow=this.currentRow.substring(0,this.currentRow.length-1),this.currentRow.length==0&&this.rows.length!=0&&(this.currentRow=this.rows[this.rows.length-1],this.rows.splice(-1,1),this.currentRow=this.currentRow.substring(0,this.currentRow.length-1))):this.rows.length!=0&&(this.currentRow=this.rows[this.rows.length-1],this.rows.splice(-1,1),this.currentRow=this.currentRow.substring(0,this.currentRow.length-2));this.text=this.text.substring(0,this.text.length-e),this.textHandle=this.text,this.inFocus&&(this.textHandle+=this.cursor),this.update()}},WIDGET3D.Text.prototype.focus=function(){this.mutable&&!this.inFocus&&(this.textHandle=this.text+this.cursor),WIDGET3D.Basic.prototype.focus.call(this),this.update()},WIDGET3D.Text.prototype.unfocus=function(){this.inFocus&&this.mutable&&(this.textHandle=this.text),WIDGET3D.Basic.prototype.unfocus.call(this),this.update()},WIDGET3D.Text.prototype.inheritance=function(){function e(){}e.prototype=this;var t=new e;return t},WIDGET3D.CameraGroup=function(e){WIDGET3D.Group.call(this);var e=e||{};this.camera=e.camera,this.container.add(this.camera)},WIDGET3D.CameraGroup.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.RollControls=function(e){var t=this;this.component=e.component,this.mouseButton=e.mouseButton!==undefined?e.mouseButton:0,this.shiftKey=e.shiftKey!==undefined?e.shiftKey:!1,this.clickLocation,this.rotationOnMouseDownY,this.rotationOnMousedownX;var n=this.component.getRotation();this.modelRotationY=n.y,this.modelRotationX=n.x,this.rotate=!1,this.mouseupHandler=function(e){if(t.rotate){e.stopPropagation(),e.preventDefault(),t.rotate=!1;var n=WIDGET3D.getApplication();n.removeEventListener("mousemove",t.mousemoveHandler),n.removeEventListener("mouseup",t.mouseupHandler)}},this.mousedownHandler=function(e){if(e.button===t.mouseButton&&e.shiftKey===t.shiftKey){e.stopPropagation(),e.preventDefault(),t.component.focus();if(!t.rotate){t.rotate=!0,t.clickLocation=WIDGET3D.mouseCoordinates(e),t.rotationOnMouseDownY=t.modelRotationY,t.rotationOnMouseDownX=t.modelRotationX;var n=WIDGET3D.getApplication();n.addEventListener("mousemove",t.mousemoveHandler,!1),n.addEventListener("mouseup",t.mouseupHandler,!1)}}},this.mousemoveHandler=function(e){if(t.rotate){e.stopPropagation(),e.preventDefault();var n=WIDGET3D.mouseCoordinates(e);t.modelRotationY=t.rotationOnMouseDownY+(n.x-t.clickLocation.x),t.modelRotationX=t.rotationOnMouseDownX+(n.y-t.clickLocation.y)}},this.component.addEventListener("mousedown",this.mousedownHandler,!1),this.animate=function(){var e=t.component.getRotation(),n=e.y+(t.modelRotationY-e.y)*.04,r=e.x+(t.modelRotationX-e.x)*.04;t.component.setRotationY(n),t.component.setRotationX(r)},this.component.addUpdateCallback(this.animate)},WIDGET3D.RollControls.prototype.remove=function(){};var THREEJS_WIDGET3D={createFunctions:function(){var e=!1,t,n,r,i,s;WIDGET3D.render=function(){var e=WIDGET3D.getAllObjects();for(var r in e)e.hasOwnProperty(r)&&e[r].update();t.render(i,n)},WIDGET3D.setViewport=function(e,r,i){t.setSize(e,r),n.aspect=i,n.updateProjectionMatrix()},WIDGET3D.getRenderer=function(){return t},WIDGET3D.getCamera=function(){return n},WIDGET3D.getCameraGroup=function(){return r},WIDGET3D.getProjector=function(){return s},WIDGET3D.getScene=function(){return i},WIDGET3D.isPluginInitialized=function(){return e},WIDGET3D.checkIfHits=function(e){var t=WIDGET3D.mouseCoordinates(e),n=new THREE.Vector3(t.x,t.y,1),r=WIDGET3D.getProjector().pickingRay(n,WIDGET3D.getCamera()),s=r.intersectObjects(i.children,!0),o=!1,u=[];if(s.length>0){for(var a=0;a<s.length;++a)if(s[a].object.visible){o=s[a].object;var f=new THREE.Matrix4;f.getInverse(s[a].object.matrixWorld);var l=s[a].point.clone().applyProjection(f),c=WIDGET3D.findObject(o,e.type);c&&u.push(c)}return u}return!1},WIDGET3D.findObject=function(e,t){var n=WIDGET3D.getApplication();for(var r=0;r<n.childEvents[t.toString()].length;++r)if(n.childEvents[t.toString()][r].isVisible&&e===n.childEvents[t.toString()][r].container)return n.childEvents[t.toString()][r];return!1},WIDGET3D.THREE_Application=function(o){if(!e){var o=o||{};if(o.renderer)t=o.renderer;else{var u=o.width!==undefined?o.width:window.innerWidth,a=o.height!==undefined?o.height:window.innerHeight,f=o.antialias!==undefined?o.antialias:!0,l=o.domParent!==undefined?o.domParent:document.body;t=new THREE.WebGLRenderer({antialias:f}),t.setSize(u,a);var c=o.clearColor!==undefined?o.clearColor:3355443,h=o.opacity!==undefined?o.opacity:1;t.setClearColor(c,h),l.appendChild(t.domElement)}if(o.camera)n=o.camera;else{var p=o.aspect!==undefined?o.aspect:t.domElement.width/t.domElement.height,d=o.fov!==undefined?o.fov:50,v=o.near!==undefined?o.near:.1,m=o.far!==undefined?o.far:2e3;n=new THREE.PerspectiveCamera(d,p,v,m)}i=o.scene!==undefined?o.scene:new THREE.Scene;var g=!1;if(!WIDGET3D.isInitialized()){g=WIDGET3D.init({collisionCallback:{callback:WIDGET3D.checkIfHits},container:THREE.Object3D,canvas:t.domElement});if(!g)return console.log("Widget3D init failed!"),!1}else g=WIDGET3D.getApplication();return i.add(g.container),s=new THREE.Projector,r=new WIDGET3D.CameraGroup({camera:n}),g.add(r),e=!0,g}return console.log("nothing to init"),WIDGET3D.getApplication()}}};THREEJS_WIDGET3D.createFunctions(),WIDGET3D.Basic.prototype.getPosition=function(){return this.container.position},WIDGET3D.Basic.prototype.getPositionX=function(){return this.container.position.x},WIDGET3D.Basic.prototype.getPositionY=function(){return this.container.position.y},WIDGET3D.Basic.prototype.getPositionZ=function(){return this.container.position.z},WIDGET3D.Basic.prototype.setPosition=function(e,t,n){this.container.position.set(e,t,n)},WIDGET3D.Basic.prototype.setPositionX=function(e){this.container.position.setX(e)},WIDGET3D.Basic.prototype.setPositionY=function(e){this.container.position.setY(e)},WIDGET3D.Basic.prototype.setPositionZ=function(e){this.container.position.setZ(e)},WIDGET3D.Basic.prototype.getRotation=function(){return this.container.useQuaternion&&this.container.rotation.setEulerFromQuaternion(this.container.quaternion),this.container.rotation},WIDGET3D.Basic.prototype.getRotationX=function(){return this.container.useQuaternion&&this.container.rotation.setEulerFromQuaternion(this.container.quaternion),this.container.rotation.x},WIDGET3D.Basic.prototype.getRotationY=function(){return this.container.useQuaternion&&this.container.rotation.setEulerFromQuaternion(this.container.quaternion),this.container.rotation.y},WIDGET3D.Basic.prototype.getRotationZ=function(){return this.container.useQuaternion&&this.container.rotation.setEulerFromQuaternion(this.container.quaternion),this.container.rotation.z},WIDGET3D.Basic.prototype.getRotationMatrix=function(){var e=new THREE.Matrix4;return e.extractRotation(this.container.matrix),e},WIDGET3D.Basic.prototype.setRotation=function(e,t,n){this.container.useQuaternion&&this.container.quaternion.setFromEuler(new THREE.Vec3(e,t,n),this.container.eulerOrder),this.container.rotation.set(e,t,n)},WIDGET3D.Basic.prototype.setRotationX=function(e){if(this.container.useQuaternion){var t=this.getRotationY(),n=this.getRotationZ();this.container.quaternion.setFromEuler(new THREE.Vec3(e,t,n),this.container.eulerOrder)}this.container.rotation.setX(e)},WIDGET3D.Basic.prototype.setRotationY=function(e){if(this.container.useQuaternion){var t=this.getRotationX(),n=this.getRotationZ();this.container.quaternion.setFromEuler(new THREE.Vec3(t,e,n),this.container.eulerOrder)}this.container.rotation.setY(e)},WIDGET3D.Basic.prototype.setRotationZ=function(e){if(this.container.useQuaternion){var t=this.getRotationX(),n=this.getRotationY();this.container.quaternion.setFromEuler(new THREE.Vec3(t,n,e),this.container.eulerOrder)}this.container.rotation.setZ(e)},WIDGET3D.Basic.prototype.useQuaternion=function(){this.container.useQuaternion=!0},WIDGET3D.Basic.prototype.setEulerOrder=function(e){this.container.eulerOrder=e},WIDGET3D.Basic.prototype.applyMatrix=function(e){this.container.applyMatrix(e)},WIDGET3D.Basic.prototype.rotateOnAxis=function(e,t){this.container.rotateOnAxis(e,t)},WIDGET3D.Basic.prototype.translateOnAxis=function(e,t){this.container.translateOnAxis(e,t)},WIDGET3D.Basic.prototype.translateX=function(e){this.container.translateX(e)},WIDGET3D.Basic.prototype.translateY=function(e){this.container.translateY(e)},WIDGET3D.Basic.prototype.translateZ=function(e){this.container.translateZ(e)},WIDGET3D.Basic.prototype.localToWorld=function(){return this.container.localToWorld()},WIDGET3D.Basic.prototype.worldToLocal=function(){return this.container.worldToLocal()},WIDGET3D.Basic.prototype.lookAt=function(e){this.container.lookAt(e)},WIDGET3D.Basic.prototype.updateMatrix=function(){this.container.updateMatrix()},WIDGET3D.Basic.prototype.updateMatrixWorld=function(){this.container.updateMatrixWorld()},WIDGET3D.Basic.prototype.computeBoundingBox=function(){return this.container.geometry.computeBoundingBox(),this.getBoundingBox()},WIDGET3D.Basic.prototype.getBoundingBox=function(){return this.container.geometry.boundingBox},WIDGET3D.Basic.prototype.computeBoundingSphere=function(){return this.container.geometry.computeBoundingSphere(),this.getBoundingSphere()},WIDGET3D.Basic.prototype.getBoundingSphere=function(){return this.container.geometry.boundingSphere},WIDGET3D.Group.prototype.getPosition=function(){return this.container.position},WIDGET3D.Group.prototype.getPositionX=function(){return this.container.position.x},WIDGET3D.Group.prototype.getPositionY=function(){return this.container.position.y},WIDGET3D.Group.prototype.getPositionZ=function(){return this.container.position.z},WIDGET3D.Group.prototype.setPosition=function(e,t,n){this.container.position.set(e,t,n)},WIDGET3D.Group.prototype.setPositionX=function(e){this.container.position.setX(e)},WIDGET3D.Group.prototype.setPositionY=function(e){this.container.position.setY(e)},WIDGET3D.Group.prototype.setPositionZ=function(e){this.container.position.setZ(e)},WIDGET3D.Group.prototype.getRotation=function(){return this.container.useQuaternion&&this.container.rotation.setEulerFromQuaternion(this.container.quaternion),this.container.rotation},WIDGET3D.Group.prototype.getRotationX=function(){return this.container.useQuaternion&&this.container.rotation.setEulerFromQuaternion(this.container.quaternion),this.container.rotation.x},WIDGET3D.Group.prototype.getRotationY=function(){return this.container.useQuaternion&&this.container.rotation.setEulerFromQuaternion(this.container.quaternion),this.container.rotation.y},WIDGET3D.Group.prototype.getRotation.z=function(){return this.container.useQuaternion&&this.container.rotation.setEulerFromQuaternion(this.container.quaternion),this.container.rotation.z},WIDGET3D.Group.prototype.getRotationMatrix=function(){var e=new THREE.Matrix4;return e.extractRotation(this.container.matrix),e},WIDGET3D.Group.prototype.setRotation=function(e,t,n){this.container.useQuaternion&&this.container.quaternion.setFromEuler(new THREE.Vec3(e,t,n),this.container.eulerOrder),this.container.rotation.set(e,t,n)},WIDGET3D.Group.prototype.setRotationX=function(e){if(this.container.useQuaternion){var t=this.getRotationY(),n=this.getRotationZ();this.container.quaternion.setFromEuler(new THREE.Vec3(e,t,n),this.container.eulerOrder)}this.container.rotation.setX(e)},WIDGET3D.Group.prototype.setRotationY=function(e){if(this.container.useQuaternion){var t=this.getRotationX(),n=this.getRotationZ();this.container.quaternion.setFromEuler(new THREE.Vec3(t,e,n),this.container.eulerOrder)}this.container.rotation.setY(e)},WIDGET3D.Group.prototype.setRotationZ=function(e){if(this.container.useQuaternion){var t=this.getRotationX(),n=this.getRotationY();this.container.quaternion.setFromEuler(new THREE.Vec3(t,n,e),this.container.eulerOrder)}this.container.rotation.setZ(e)},WIDGET3D.Group.prototype.useQuaternion=function(){this.container.useQuaternion=!0},WIDGET3D.Group.prototype.setEulerOrder=function(e){this.container.eulerOrder=e},WIDGET3D.Group.prototype.applyMatrix=function(e){this.container.applyMatrix(e)},WIDGET3D.Group.prototype.rotateOnAxis=function(e,t){this.container.rotateOnAxis(e,t)},WIDGET3D.Group.prototype.translateOnAxis=function(e,t){this.container.translateOnAxis(e,t)},WIDGET3D.Group.prototype.translateX=function(e){this.container.translateX(e)},WIDGET3D.Group.prototype.translateY=function(e){this.container.translateY(e)},WIDGET3D.Group.prototype.translateZ=function(e){this.container.translateZ(e)},WIDGET3D.Group.prototype.localToWorld=function(){return this.container.localToWorld()},WIDGET3D.Group.prototype.worldToLocal=function(){return this.container.worldToLocal()},WIDGET3D.Group.prototype.lookAt=function(e){this.container.lookAt(e)},WIDGET3D.Group.prototype.updateMatrix=function(){this.container.updateMatrix()},WIDGET3D.Group.prototype.updateMatrixWorld=function(){this.container.updateMatrixWorld()},WIDGET3D.Group.prototype.computeBoundingBox=function(){var e=this.getBoundingSphere();return e==undefined&&(e=this.computeBoundingSphere()),this.boundingBox=e.getBoundingBox(),this.boundingBox},WIDGET3D.Group.prototype.getBoundingBox=function(){return this.boundingBox},WIDGET3D.Group.prototype.computeBoundingSphere=function(){var e=this.getPosition(),t=0;for(var n=0;n<this.children.length;++n){var r=this.children[n].computeBoundingSphere(),i=e.distanceTo(r.center)+r.radius;n==0&&(t=i),i>t&&(t=i)}return this.boundingSphere=new THREE.Sphere(e,t),this.boundingSphere},WIDGET3D.Group.prototype.getBoundingSphere=function(){return this.boundingSphere},WIDGET3D.GridWindow=function(e){var t=this;WIDGET3D.Group.call(this);var e=e||{};this.width=e.width!==undefined?e.width:1e3,this.height=e.height!==undefined?e.height:1e3,this.density=e.density!==undefined?e.density:6,this.depth=this.width/this.density,this.maxChildren=this.density*this.density,this.color=e.color!==undefined?e.color:7039851,this.lineWidth=e.lineWidth!==undefined?e.lineWidth:2,this.opacity=e.opacity!==undefined?e.opacity:.5,this.material=new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity,wireframe:!0,side:THREE.DoubleSide,wireframeLinewidth:this.lineWidth});var n=new THREE.CubeGeometry(this.width,this.height,this.depth,this.density,this.density,1),r=new THREE.Mesh(n,this.material);this.grid=new WIDGET3D.Basic,this.grid.setMesh(r);var i=e.hideGrid!==undefined?e.hideGrid:!1;i&&this.grid.hide(),this.add(this.grid),this.icons=new Array,this.defaultControls=e.defaultControls!==undefined?e.defaultControls:!1;if(this.defaultControls){var s=e.mouseButton!==undefined?e.mouseButton:0,o=e.shiftKey!==undefined?e.shiftKey:!1;this.controls=new WIDGET3D.RollControls({component:this,mouseButton:s,shiftKey:o})}},WIDGET3D.GridWindow.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.GridWindow.prototype.addSlots=function(e){this.density=e,this.maxChildren=e*e,this.depth=this.width/this.density;var t=new THREE.CubeGeometry(this.width,this.height,this.depth,this.density,this.density,1),n=new THREE.Mesh(t,this.material);this.grid.setMesh(n);var r=this.icons;this.icons=new Array;for(var i=0;i<r.length;++i){var s=r[i];this.icons.push(s),s.width=this.width/(this.density+3.3),s.height=this.height/(this.density+3.3);var o=new THREE.CubeGeometry(s.width,s.height,s.depth),u=new THREE.Mesh(o,s.material);s.setMesh(u),s.setToPlace()}},WIDGET3D.GridIcon=function(e){WIDGET3D.Basic.call(this);var e=e||{},t=e.parent;if(t==undefined)return console.log("GridIcon needs to have grid window as parent!"),console.log("Parent has to be given in parameters."),!1;t.icons.length>=t.maxChildren&&(console.log("Grid is full! Creating bigger one"),t.addSlots(Math.ceil(t.density*1.5))),this.color=e.color!==undefined?e.color:16777215,this.url=e.url!==undefined?e.url:!1,this.img=e.img!==undefined?e.img:!1,this.metadata=e.metadata!==undefined?e.metadata:!1,this.width=t.width/(t.density+3.3),this.height=t.height/(t.density+3.3),this.depth=e.depth!==undefined?e.depth:this.height;var n=new THREE.CubeGeometry(this.width,this.height,this.depth);this.texture=!1,this.img?(this.texture=new THREE.Texture(this.img),this.texture.needsUpdate=!0):this.url&&(this.texture=THREE.ImageUtils.loadTexture(this.url)),this.material=new THREE.MeshBasicMaterial({map:this.texture,color:this.color});var r=new THREE.Mesh(n,this.material);this.setMesh(r),t.add(this),t.icons.push(this),this.setToPlace()},WIDGET3D.GridIcon.prototype=WIDGET3D.Basic.prototype.inheritance(),WIDGET3D.GridIcon.prototype.setToPlace=function(){var e=this.parent.getPosition(),t=-this.parent.width/2+e.x/this.parent.width,n=this.parent.height/2+e.y/this.parent.height,r=this.parent.width/this.parent.density,i=this.parent.height/this.parent.density,s=r/2,o=i/2;if(this.parent.icons.length-1>0){var u=this.parent.icons[this.parent.icons.length-2],a=u.getPosition();if((this.parent.icons.length-1)%this.parent.density==0)var f=t+s,l=a.y-i;else var f=a.x+r,l=a.y}else var f=t+s,l=n-o;this.setPosition(f,l,e.z/this.parent.height)},WIDGET3D.TitledWindow=function(e){WIDGET3D.Group.call(this);var t=this,e=e||{};this.width=e.width!==undefined?e.width:2e3,this.height=e.height!==undefined?e.height:2e3;var n=e.title!==undefined?e.title:"title",r=e.color!==undefined?e.color:8421504,i=e.texture,s=e.material!==undefined?e.material:new THREE.MeshBasicMaterial({color:r,map:i,side:THREE.DoubleSide});this.title=new WIDGET3D.Basic;var o=this.createTitle(n,s.side);this.title.setMesh(o),this.add(this.title),this.content=new WIDGET3D.Basic;var u=new THREE.Mesh(new THREE.PlaneGeometry(this.width,this.height),s);this.content.setMesh(u),this.add(this.content),this.closeButton=new WIDGET3D.Basic;var a=new THREE.Mesh(new THREE.PlaneGeometry(this.width/10,this.height/10),new THREE.MeshBasicMaterial({color:11141120,side:s.side}));this.closeButton.setMesh(a),this.closeButton.setPosition(this.width/2-this.width/20,this.height/2+this.height/20,0),this.add(this.closeButton);var f=function(e){return function(){e.remove()}};this.closeButton.addEventListener("click",f(this)),this.defaultControls=e.defaultControls!==undefined?e.defaultControls:!1;if(this.defaultControls){var l=e.mouseButton!==undefined?e.mouseButton:0,c=e.shiftKey!==undefined?e.shiftKey:!1,h=e.attached!==undefined?e.attached:!1,p=e.debug!==undefined?e.debug:!1;this.controls=new WIDGET3D.DragControls({debug:p,component:this,mouseButton:l,shiftKey:c,width:this.width*2,height:(this.height+this.title.height)*2})}},WIDGET3D.TitledWindow.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.TitledWindow.prototype.createTitle=function(e,t){this.textureCanvas=document.createElement("canvas"),this.textureCanvas.width=512,this.textureCanvas.height=128,this.textureCanvas.style.display="none",document.body.appendChild(this.textureCanvas),this.setTitle(e);var n=new THREE.Texture(this.textureCanvas);n.needsUpdate=!0;var r=new THREE.MeshBasicMaterial({map:n,side:t});this.title.width=this.width-this.width/10,this.title.height=this.height/10;var i=new THREE.Mesh(new THREE.PlaneGeometry(this.title.width,this.title.height),r);return i.position.y=this.height/2+this.height/20,i.position.x=(this.width-this.width/10)/2-this.width/2,i},WIDGET3D.TitledWindow.prototype.setTitle=function(e){var t=this.textureCanvas.getContext("2d");t.fillStyle="#B3B3B3",t.fillRect(0,0,this.textureCanvas.width,this.textureCanvas.height),t.fillStyle="#000000",t.font="bold 60px Courier New",t.align="center",t.textBaseline="middle",t.fillText(e,10,this.textureCanvas.height/2)},WIDGET3D.TitledWindow.prototype.updateTitle=function(e){this.setTitle(e),this.title.container.material.map.needsUpdate=!0},WIDGET3D.TitledWindow.prototype.remove=function(){this.hide();var e=this.textureCanvas;document.body.removeChild(e),this.defaultControls&&this.controls.remove(),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.TitledWindow.prototype.getContent=function(){return this.content},WIDGET3D.Dialog=function(e){WIDGET3D.Group.call(this);var e=e||{};this.width=e.width!==undefined?e.width:1e3,this.height=e.height!==undefined?e.height:1e3,this.depth=e.depth!==undefined?e.depth:20,this.color=e.color!==undefined?e.color:12636368,this.opacity=e.opacity!==undefined?e.opacity:.9,this.title=e.title!==undefined?e.title:"This is a dialog",this.fields=e.fields!==undefined?e.fields:[],this.buttons=e.buttons!==undefined?e.buttons:[],this.hasCancel=e.hasCancel!==undefined?e.hasCancel:!1;if(this.hasCancel){this.cancelText=e.cancelText!==undefined?e.cancelText:"Cancel";var t=function(e){return function(){e.remove()}};this.buttons.push({text:this.cancelText,onclick:t(this)})}this.componentHeight=this.height/((this.fields.length+3)*1.3),this.createDialogTitle(),this.createButtons(),this.createTextfields()},WIDGET3D.Dialog.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.Dialog.prototype.createDialogTitle=function(){this.canvas=document.createElement("canvas"),this.canvas.width=512,this.canvas.height=512,this.canvas.style.display="none",document.body.appendChild(this.canvas);var e=this.canvas.getContext("2d");e.fillStyle="#FFFFFF",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="#000000",e.font="bold 30px Courier New",e.align="center",e.textBaseline="middle";var t=e.measureText(this.title).width,n=e.measureText(this.title).height;e.fillText(this.title,this.canvas.width/2-t/2,30);var r=new THREE.Texture(this.canvas);r.needsUpdate=!0;var i=new Array;i.push(new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity})),i.push(new THREE.MeshBasicMaterial({map:r,color:this.color,opacity:this.opacity}));var s=new THREE.CubeGeometry(this.width,this.height,this.depth*.75);for(var o=0;o<s.faces.length;o++){var u=s.faces[o];o===4||o==5?u.materialIndex=1:u.materialIndex=0}s.materials=i;var a=new THREE.MeshFaceMaterial(i),f=new THREE.Mesh(s,a),l=new WIDGET3D.Basic;l.setMesh(f),this.add(l)},WIDGET3D.Dialog.prototype.createButtons=function(){var e=this.width/(this.buttons.length+2),t=this.componentHeight,n=-this.width/2,r=-this.height/2+1,i=this.width/this.buttons.length,s=i/2,o=r+t/2,u=0;for(var a=0;a<this.buttons.length;++a){var f=document.createElement("canvas");f.width=512,f.height=128,f.style.display="none",document.body.appendChild(f),this.buttons[a].canvas=f;var l=f.getContext("2d");l.fillStyle="#B3B3B3",l.fillRect(0,0,f.width,f.height),l.fillStyle="#000000",l.font="bold 60px Courier New",l.align="center",l.textBaseline="middle";var c=l.measureText(this.buttons[a].text).width;l.fillText(this.buttons[a].text,f.width/2-c/2,f.height/2);var h=new THREE.Texture(f);h.needsUpdate=!0;var p=new THREE.MeshBasicMaterial({map:h}),d=new THREE.CubeGeometry(e,t,this.depth),v=this.createFaceMaterialsMesh(p,d),m=new WIDGET3D.Basic;m.setMesh(v),m.addEventListener("click",this.buttons[a].onclick,!1),this.add(m);if(a==0)var g=n+s;else var g=u+i;m.setPosition(g,o,this.getPosition().z),u=g}},WIDGET3D.Dialog.prototype.createTextfields=function(){var e=function(e){return function(t){t.stopPropagation(),t.preventDefault(),WIDGET3D.unfocusFocused(),e.focus()}},t=function(e){return function(t){t.stopPropagation();if(t.charCode!=0){var n=String.fromCharCode(t.charCode);e.addLetter(n)}else t.type=="keydown"&&(t.keyCode==8||t.keyCode==46)&&e.erase(1)}},n=function(e,t,n){return function(){var r=e.getContext("2d");r.fillStyle="#FFFFFF",r.fillRect(0,0,e.width,e.height),r.fillStyle="#000000",r.font="bold 50px Courier New",r.align="center",r.textBaseline="middle",r.fillText(t.textHandle,5,e.height/2),n.needsUpdate=!0}},r=this.width/2.5,i=this.componentHeight,s=-this.width/2,o=this.width/2,u=this.height/2-i,a=(this.height-2*i)/this.fields.length,f=a/2,l=o-r/1.5,c=s+r/1.5,h=0;for(var p=0;p<this.fields.length;++p){var d=document.createElement("canvas");d.width=512,d.height=128,d.style.display="none",document.body.appendChild(d),this.fields[p].canvas1=d;var v=new THREE.Texture(d),m=new THREE.MeshBasicMaterial({map:v}),g=new THREE.CubeGeometry(r,i,this.depth),y=this.createFaceMaterialsMesh(m,g),b=new WIDGET3D.Text({maxLength:this.fields[p].maxLength});b.setText(""),b.setMesh(y),b.addEventListener("click",e(b),!1),b.addEventListener("keypress",t(b)),b.addEventListener("keydown",t(b)),b.addUpdateCallback(n(d,b,v)),this.add(b);var w=document.createElement("canvas");w.width=512,w.height=128,w.style.display="none",document.body.appendChild(w),this.fields[p].canvas2=w;var E=w.getContext("2d");E.fillStyle="#FFFFFF",E.fillRect(0,0,w.width,w.height),E.fillStyle="#000000",E.font="bold 60px Courier New",E.align="center",E.textBaseline="middle";var S=E.measureText(this.fields[p].description).width;E.fillText(this.fields[p].description,w.width/2-S/2,w.height/2);var x=new THREE.Texture(w);x.needsUpdate=!0;var T=new THREE.MeshBasicMaterial({map:x,color:this.color,opacity:this.opacity}),N=new THREE.CubeGeometry(r,i,this.depth),C=this.createFaceMaterialsMesh(T,N),k=new WIDGET3D.Basic;k.setMesh(C),this.add(k);if(p==0)var L=u-f;else var L=h-a;b.setPosition(l,L,this.getPosition().z),k.setPosition(c,L,this.getPosition().z),h=L}},WIDGET3D.Dialog.prototype.createFaceMaterialsMesh=function(e,t){var n=new Array;n.push(new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity})),n.push(e);for(var r=0;r<t.faces.length;r++){var i=t.faces[r];r===4||r==5?i.materialIndex=1:i.materialIndex=0}t.materials=n;var s=new THREE.MeshFaceMaterial(n),o=new THREE.Mesh(t,s);return o},WIDGET3D.Dialog.prototype.remove=function(){for(var e=0;e<this.buttons.length;++e)document.body.removeChild(this.buttons[e].canvas);for(var t=0;t<this.fields.length;++t)document.body.removeChild(this.fields[t].canvas1),document.body.removeChild(this.fields[t].canvas2);document.body.removeChild(this.canvas),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.SelectDialog=function(e){WIDGET3D.Group.call(this);var e=e||{};this.width=e.width!==undefined?e.width:1e3,this.height=e.height!==undefined?e.height:1e3,this.depth=e.depth!==undefined?e.depth:10,this.color=e.color!==undefined?e.color:12636368,this.opacity=e.opacity!==undefined?e.opacity:.9,this.choices=e.choices!==undefined?e.choices:[],this.hasCancel=e.hasCancel!==undefined?e.hasCancel:!1,this.text=e.text!==undefined?e.text:!1;if(this.hasCancel){this.cancelText=e.cancelText!==undefined?e.cancelText:"Cancel";var t=function(e){return function(){e.remove()}},n=t(this);this.choices.push({string:this.cancelText,onclick:{handler:n}})}this.text?this.createText():this.choiceHeight=this.height/(this.choices.length*1.2),this.choiceCanvases=[],this.createChoises()},WIDGET3D.SelectDialog.prototype=WIDGET3D.Group.prototype.inheritance(),WIDGET3D.SelectDialog.prototype.createText=function(){this.textCanvas=document.createElement("canvas"),this.textCanvas.width=512,this.textCanvas.height=128,this.textCanvas.style.display="none",document.body.appendChild(this.textCanvas);var e=this.textCanvas.getContext("2d");this.choiceHeight=this.height/((this.choices.length+1)*1.2);var t=this.createTitle(this.text,e,this.textCanvas);t.position.y=this.height*.5-this.choiceHeight*.5;var n=new WIDGET3D.Basic;n.setMesh(t),this.add(n),this.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault()},!1)},WIDGET3D.SelectDialog.prototype.createChoises=function(){var e=0;for(var t=0;t<this.choices.length;++t){var n=new WIDGET3D.Basic,r=document.createElement("canvas");this.choiceCanvases.push(r),r.width=512,r.height=128,r.style.display="none",document.body.appendChild(r);var i=r.getContext("2d"),s=this.width/1.2,o=this.choiceHeight,u=this.createButtonMaterial(this.choices[t].string,i,r),a=new THREE.CubeGeometry(s,o,this.depth);for(var f=0;f<a.faces.length;f++){var l=a.faces[f];f===4||f==5?l.materialIndex=1:l.materialIndex=0}a.materials=u;var c=new THREE.MeshFaceMaterial(u),h=new THREE.Mesh(a,c);n.setMesh(h);var p=this.getPosition(),d=0;t==0?this.text?d=this.height*.5-o*1.7:d=this.height*.5-o*.5:d=e-1.2*o,e=d,n.setPosition(p.x,d,p.z),n.addEventListener("click",this.choices[t].onclick.handler,!1),n.menuID=t,this.add(n)}},WIDGET3D.SelectDialog.prototype.createButtonMaterial=function(e,t,n){t.fillStyle="#FFFFFF",t.fillRect(0,0,n.width,n.height),t.fillStyle="#000000",t.font="bold 40px Courier New",t.align="center",t.textBaseline="middle";var r=t.measureText(e).width;t.fillText(e,n.width/2-r/2,n.height/2);var i=new THREE.Texture(n);i.needsUpdate=!0;var s=new Array;return s.push(new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity})),s.push(new THREE.MeshBasicMaterial({map:i,color:this.color,opacity:this.opacity})),s},WIDGET3D.SelectDialog.prototype.createTitle=function(e,t,n){t.fillStyle="#FFFFFF",t.fillRect(0,0,n.width,n.height),t.fillStyle="#000000",t.font="bold 45px Courier New",t.align="center",t.textBaseline="middle";var r=t.measureText(e).width;t.fillText(e,n.width/2-r/2,n.height/2);var i=new THREE.Texture(n);i.needsUpdate=!0;var s=new Array;s.push(new THREE.MeshBasicMaterial({color:this.color,opacity:this.opacity})),s.push(new THREE.MeshBasicMaterial({map:i,color:this.color,opacity:this.opacity}));var o=new THREE.CubeGeometry(this.width,this.choiceHeight,this.depth);for(var u=0;u<o.faces.length;u++){var a=o.faces[u];u===4||u===5?a.materialIndex=1:a.materialIndex=0}o.materials=s;var f=new THREE.MeshFaceMaterial(s),l=new THREE.Mesh(o,f);return l},WIDGET3D.SelectDialog.prototype.changeChoiceText=function(e,t){var n=!1;for(var r=0;r<this.children.length;++r)if(this.children[r].menuID==t){n=this.children[r];break}if(n){var i=n.container.material.map.image,s=n.container.material.map.image.getContext("2d"),o=this.createButtonMaterial(e,s,i);return n.container.geometry.materials=o,n.container.material=new THREE.MeshFaceMaterial(o),n.container.needsUpdate=!0,!0}return!1},WIDGET3D.SelectDialog.prototype.remove=function(){for(var e=0;e<this.choiceCanvases.length;++e)t=this.choiceCanvases[e],document.body.removeChild(t);this.choiceCanvases=null;var t=this.textCanvas;document.body.removeChild(t),WIDGET3D.Group.prototype.remove.call(this)},WIDGET3D.DragControls=function(e){var t=this;t.setPlaneRotation=function(){var e=t.camera.rotation.clone(),n=t.camera.parent;while(n!=undefined&&n!=t.component.parent)e.add(n.rotation.clone()),n=n.parent;t.plane.rotation.copy(e)},t.component=e.component,t.mouseButton=e.mouseButton!==undefined?e.mouseButton:0,t.shiftKey=e.shiftKey!==undefined?e.shiftKey:!1,t.start=!1,t.camera=WIDGET3D.getCamera();var n=e.width!==undefined?e.width:2e3,r=e.height!==undefined?e.height:2e3,i=e.debug!==undefined?e.debug:!1;t.drag=!1,t.offset=new THREE.Vector3,t.plane=new THREE.Mesh(new THREE.PlaneGeometry(n,r,8,8),new THREE.MeshBasicMaterial({color:0,opacity:.25,transparent:!0,wireframe:!0,side:THREE.DoubleSide})),t.plane.visible=i,t.setPlaneRotation(),WIDGET3D.getScene().add(t.plane),t.mouseupHandler=function(e){t.drag&&(t.drag=!1,t.plane.position.copy(t.component.parent.container.localToWorld(t.component.getPosition().clone())),WIDGET3D.getApplication().removeEventListener("mousemove",t.mousemoveHandler),WIDGET3D.getApplication().removeEventListener("mouseup",t.mouseupHandler))},t.mousedownHandler=function(e){if(e.button===t.mouseButton&&e.shiftKey===t.shiftKey){t.start=!0;if(!t.drag){t.setPlaneRotation(),t.plane.position.copy(t.component.parent.container.localToWorld(t.component.getPosition().clone())),t.plane.updateMatrixWorld(!0);var n=WIDGET3D.mouseCoordinates(e),r=new THREE.Vector3(n.x,n.y,1),i=WIDGET3D.getProjector().pickingRay(r,t.camera),s=i.intersectObject(t.plane);s.length>0&&t.offset.copy(s[0].point).sub(t.plane.position),WIDGET3D.getApplication().addEventListener("mousemove",t.mousemoveHandler,!1),WIDGET3D.getApplication().addEventListener("mouseup",t.mouseupHandler,!1),t.component.focus(),t.drag=!0}}},t.mousemoveHandler=function(e){if(t.drag){var n=WIDGET3D.mouseCoordinates(e),r=new THREE.Vector3(n.x,n.y,1),i=WIDGET3D.getProjector().pickingRay(r,t.camera),s=i.intersectObject(t.plane);if(s.length>0){var o=s[0].point.sub(t.offset);t.plane.position.copy(o);var u=t.component.parent.container.worldToLocal(o);t.component.setPosition(u.x,u.y,u.z)}}},t.component.addEventListener("mousedown",t.mousedownHandler,!1),t.remove=function(){WIDGET3D.getScene().remove(t.plane),t.plane.geometry.dispose(),t.plane.material.dispose(),t.plane=undefined}}